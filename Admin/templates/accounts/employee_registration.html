{% extends "partials/layouts/main.html" %}
{% load static %}

{% include "partials/main.html" %}
{% block meta %}
{% with title="Employee Registration" %}
{% include "partials/title-meta.html" %}
{% endwith %}
{% endblock %}
{% block css %}
<link rel="stylesheet" href="/static/assets/libs/choices.js/public/assets/styles/choices.min.css">
<link rel="stylesheet" href="/static/assets/libs/dragula/dragula.min.css">
<link rel="stylesheet" href="/static/assets/libs/air-datepicker/air-datepicker.css">
{% endblock %}
{% block content %}
{% with title_sub="HR Management" title=page_title|default:"Employee Registration"%}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <div class="fs-4 mb-3 bg-primary-subtle text-primary avatar-lg d-inline-flex align-items-center justify-content-center rounded-circle">
                    <i class="ri-user-line"></i>
                </div>
                <h4>{{ employee_stats.total_employees|default:0 }}</h4>
                <span>Total Employees</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="fs-4 mb-3 bg-warning-subtle text-warning avatar-lg d-inline-flex align-items-center justify-content-center rounded-circle">
                    <i class="ri-time-line"></i>
                </div>
                <h4>{{ employee_stats.probation_employees|default:0 }}</h4>
                <span>On Probation</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="fs-4 mb-3 bg-success-subtle text-success avatar-lg d-inline-flex align-items-center justify-content-center rounded-circle">
                    <i class="ri-checkbox-circle-line"></i>
                </div>
                <h4>{{ employee_stats.confirmed_employees|default:0 }}</h4>
                <span>Confirmed</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="fs-4 mb-3 bg-info-subtle text-info avatar-lg d-inline-flex align-items-center justify-content-center rounded-circle">
                    <i class="ri-building-line"></i>
                </div>
                <h4>{{ total_departments|default:0 }}</h4>
                <span>Departments</span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>{{ form_title|default:"Employee Registration" }}</h4>
                <div class="d-flex gap-2">
                    <a href="{% url 'accounts:employee_list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="ri-arrow-left-line me-1"></i>Back to List
                    </a>
                    {% if is_update %}
                    <a href="{% url 'accounts:employee_detail' object.pk %}" class="btn btn-outline-primary btn-sm">
                        <i class="ri-eye-line me-1"></i>View Details
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <form method="POST" enctype="multipart/form-data" id="employeeForm">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            <div>{{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="row g-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="ri-user-line me-2"></i>Personal Information
                            </h6>
                        </div>
                        
                        {% if not is_update %}
                        <div class="col-12">
                            <div class="bg-light p-3 rounded">
                                <div class="d-flex align-items-center">
                                    <i class="ri-information-line text-info me-2"></i>
                                    <small class="text-muted">Employee code will be auto-generated based on selected role</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if is_update %}
                        <div class="col-md-4">
                            <label for="{{ form.employee_code.id_for_label }}" class="form-label">
                                Employee Code <span class="text-danger">*</span>
                            </label>
                            {{ form.employee_code }}
                            {% if form.employee_code.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.employee_code.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="col-md-4">
                            <label for="{{ form.first_name.id_for_label }}" class="form-label">
                                First Name <span class="text-danger">*</span>
                            </label>
                            {{ form.first_name }}
                            {% if form.first_name.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.first_name.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.middle_name.id_for_label }}" class="form-label">Middle Name</label>
                            {{ form.middle_name }}
                            {% if form.middle_name.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.middle_name.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.last_name.id_for_label }}" class="form-label">
                                Last Name <span class="text-danger">*</span>
                            </label>
                            {{ form.last_name }}
                            {% if form.last_name.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.last_name.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.email.id_for_label }}" class="form-label">
                                Email Address <span class="text-danger">*</span>
                            </label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.email.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                                Phone Number
                            </label>
                            {{ form.phone_number }}
                            {% if form.phone_number.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.phone_number.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">
                                Date of Birth
                            </label>
                            {{ form.date_of_birth }}
                            {% if form.date_of_birth.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.date_of_birth.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.gender.id_for_label }}" class="form-label">
                                Gender
                            </label>
                            {{ form.gender }}
                            {% if form.gender.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.gender.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                                <i class="ri-map-pin-line me-2"></i>Address Information
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.address_line1.id_for_label }}" class="form-label">Address Line 1</label>
                            {{ form.address_line1 }}
                            {% if form.address_line1.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.address_line1.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.address_line2.id_for_label }}" class="form-label">Address Line 2</label>
                            {{ form.address_line2 }}
                            {% if form.address_line2.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.address_line2.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.city.id_for_label }}" class="form-label">City</label>
                            {{ form.city }}
                            {% if form.city.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.city.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.state.id_for_label }}" class="form-label">State</label>
                            {{ form.state }}
                            {% if form.state.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.state.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.postal_code.id_for_label }}" class="form-label">Postal Code</label>
                            {{ form.postal_code }}
                            {% if form.postal_code.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.postal_code.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-12">
                            <label for="{{ form.country.id_for_label }}" class="form-label">Country</label>
                            {{ form.country }}
                            {% if form.country.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.country.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                                <i class="ri-phone-line me-2"></i>Emergency Contact
                            </h6>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.emergency_contact_name.id_for_label }}" class="form-label">
                                Emergency Contact Name
                            </label>
                            {{ form.emergency_contact_name }}
                            {% if form.emergency_contact_name.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.emergency_contact_name.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.emergency_contact_phone.id_for_label }}" class="form-label">
                                Emergency Contact Phone
                            </label>
                            {{ form.emergency_contact_phone }}
                            {% if form.emergency_contact_phone.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.emergency_contact_phone.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label for="{{ form.emergency_contact_relationship.id_for_label }}" class="form-label">
                                Relationship
                            </label>
                            {{ form.emergency_contact_relationship }}
                            {% if form.emergency_contact_relationship.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.emergency_contact_relationship.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                                <i class="ri-briefcase-line me-2"></i>Employment Information
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.department.id_for_label }}" class="form-label">
                                Department <span class="text-danger">*</span>
                            </label>
                            {{ form.department }}
                            {% if form.department.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.department.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.role.id_for_label }}" class="form-label">
                                Role <span class="text-danger">*</span>
                            </label>
                            {{ form.role }}
                            {% if form.role.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.role.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.job_title.id_for_label }}" class="form-label">
                                Job Title
                            </label>
                            {{ form.job_title }}
                            {% if form.job_title.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.job_title.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.hire_date.id_for_label }}" class="form-label">
                                Hire Date
                            </label>
                            {{ form.hire_date }}
                            {% if form.hire_date.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.hire_date.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-12">
                            <label for="{{ form.manager.id_for_label }}" class="form-label">Reporting Manager</label>
                            {{ form.manager }}
                            {% if form.manager.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.manager.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        {% if not is_update %}
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                                <i class="ri-lock-line me-2"></i>Account Security
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.password1.id_for_label }}" class="form-label">
                                Password <span class="text-danger">*</span>
                            </label>
                            <div class="position-relative">
                                {{ form.password1 }}
                                <button type="button"
                                    class="btn btn-link position-absolute end-0 top-50 translate-middle-y text-decoration-none text-muted toggle-password"
                                    data-target="{{ form.password1.id_for_label }}" style="z-index: 10; padding: 0.375rem 0.75rem;">
                                    <i class="ri-eye-off-line align-middle"></i>
                                </button>
                            </div>
                            {% if form.password1.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.password1.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            {% if form.password1.help_text %}
                                <div class="form-text">{{ form.password1.help_text }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label for="{{ form.password2.id_for_label }}" class="form-label">
                                Confirm Password <span class="text-danger">*</span>
                            </label>
                            <div class="position-relative">
                                {{ form.password2 }}
                                <button type="button"
                                    class="btn btn-link position-absolute end-0 top-50 translate-middle-y text-decoration-none text-muted toggle-password"
                                    data-target="{{ form.password2.id_for_label }}" style="z-index: 10; padding: 0.375rem 0.75rem;">
                                    <i class="ri-eye-off-line align-middle"></i>
                                </button>
                            </div>
                            {% if form.password2.errors %}
                                <div class="text-danger fs-12 mt-1">
                                    {% for error in form.password2.errors %}
                                        <div>{{ error }}</div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="col-12 mt-4">
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="button" class="btn btn-outline-info" onclick="validateForm()">
                                    <i class="ri-check-line me-1"></i>Validate Form
                                </button>
                                <div class="d-flex gap-2">
                                    <a href="{% url 'accounts:employee_list' %}" class="btn btn-outline-secondary">
                                        <i class="ri-close-line me-1"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="ri-user-add-line me-1"></i>{% if is_update %}Update{% else %}Create{% endif %} Employee
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validationModalLabel">Form Validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="validationResults"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script src="/static/assets/libs/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="/static/assets/libs/air-datepicker/air-datepicker.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('employeeForm');
    const emailField = document.getElementById('{{ form.email.id_for_label }}');
    const departmentField = document.getElementById('{{ form.department.id_for_label }}');
    const roleField = document.getElementById('{{ form.role.id_for_label }}');
    const managerField = document.getElementById('{{ form.manager.id_for_label }}');
    
    const toggleButtons = document.querySelectorAll('.toggle-password');
    toggleButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const passwordField = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (passwordField && passwordField.type === 'password') {
                passwordField.type = 'text';
                icon.className = 'ri-eye-line align-middle';
            } else if (passwordField) {
                passwordField.type = 'password';
                icon.className = 'ri-eye-off-line align-middle';
            }
        });
    });
    
    if (emailField) {
        emailField.addEventListener('blur', function() {
            validateEmail(this.value);
        });
    }
    
    const dateFields = document.querySelectorAll('input[type="date"]');
    dateFields.forEach(field => {
        if (field.classList.contains('air-datepicker')) return;
        
        new AirDatepicker(field, {
            locale: {
                days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                daysShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                daysMin: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'],
                months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                monthsShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
            },
            dateFormat: 'yyyy-MM-dd',
            autoClose: true
        });
    });
    
    if (departmentField && roleField && managerField) {
        new Choices(departmentField, {
            searchEnabled: true,
            placeholder: true,
            placeholderValue: 'Select Department'
        });
        
        new Choices(roleField, {
            searchEnabled: true,
            placeholder: true,
            placeholderValue: 'Select Role'
        });
        
        new Choices(managerField, {
            searchEnabled: true,
            placeholder: true,
            placeholderValue: 'Select Manager'
        });
    }
    
    function validateEmail(email) {
        if (!email) return;
        
        const employeeId = '{{ object.pk|default:"" }}';
        fetch(`{% url 'accounts:validate_email_ajax' %}?email=${email}&employee_id=${employeeId}`)
            .then(response => response.json())
            .then(data => {
                const field = emailField.parentElement;
                const existingFeedback = field.querySelector('.validation-feedback');
                if (existingFeedback) existingFeedback.remove();
                
                const feedback = document.createElement('div');
                feedback.className = `validation-feedback small ${data.valid ? 'text-success' : 'text-danger'}`;
                feedback.textContent = data.message;
                field.appendChild(feedback);
                
                emailField.classList.toggle('is-valid', data.valid);
                emailField.classList.toggle('is-invalid', !data.valid);
            })
            .catch(error => console.log('Validation error:', error));
    }
    
    window.validateForm = function() {
        const formData = new FormData(form);
        const results = [];
        
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                const label = field.previousElementSibling;
                const fieldName = label ? label.textContent.replace('*', '').trim() : field.name;
                results.push(`${fieldName} is required`);
            }
        });
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailField && emailField.value && !emailRegex.test(emailField.value)) {
            results.push('Please enter a valid email address');
        }
        
        const phoneField = document.getElementById('{{ form.phone_number.id_for_label }}');
        if (phoneField && phoneField.value) {
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            if (!phoneRegex.test(phoneField.value.replace(/\s/g, ''))) {
                results.push('Please enter a valid phone number');
            }
        }
        
        const password1Field = document.getElementById('{{ form.password1.id_for_label }}');
        const password2Field = document.getElementById('{{ form.password2.id_for_label }}');
        if (password1Field && password2Field) {
            if (password1Field.value !== password2Field.value) {
                results.push('Passwords do not match');
            }
            if (password1Field.value && password1Field.value.length < 8) {
                results.push('Password must be at least 8 characters long');
            }
        }
        
        const resultsDiv = document.getElementById('validationResults');
        if (results.length === 0) {
            resultsDiv.innerHTML = '<div class="alert alert-success"><i class="ri-check-line me-2"></i>All validations passed! Form is ready to submit.</div>';
        } else {
            resultsDiv.innerHTML = '<div class="alert alert-danger"><h6>Please fix the following issues:</h6><ul class="mb-0">' + 
                results.map(result => `<li>${result}</li>`).join('') + '</ul></div>';
        }
        
        new bootstrap.Modal(document.getElementById('validationModal')).show();
    };
    
    form.addEventListener('submit', function(e) {
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="ri-loader-4-line me-1 spinner-border spinner-border-sm"></i>Processing...';
    });
});
</script>
{% endblock %}

