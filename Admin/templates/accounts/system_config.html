{% extends "partials/layouts/main.html" %}
{% load static %}

{% include "partials/main.html" %}
{% block meta %}
{% with title="System Configuration" %}
{% include "partials/title-meta.html" %}
{% endwith %}
{% endblock %}

{% block css %}
<link rel="stylesheet" href="/static/assets/libs/choices.js/public/assets/styles/choices.min.css">
<style>
.config-card {
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}
.config-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.config-card.system { border-left-color: #6c5ce7; }
.config-card.security { border-left-color: #fd79a8; }
.config-card.attendance { border-left-color: #00b894; }
.config-card.payroll { border-left-color: #fdcb6e; }
.config-card.leave { border-left-color: #e17055; }
.config-card.device { border-left-color: #74b9ff; }
.config-card.notification { border-left-color: #a29bfe; }
.config-card.calculation { border-left-color: #fd79a8; }
.config-card.validation { border-left-color: #00cec9; }
.config-card.integration { border-left-color: #55a3ff; }
.setting-type-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}
.config-value {
    background: #f8f9fa;
    padding: 0.5rem;
    border-radius: 0.375rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
{% if action == 'list' or not action %}
{% with title_sub="System Administration" title="System Configuration" %}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">System Configuration</h4>
                        <p class="text-muted mb-0">Manage global system settings and configurations</p>
                    </div>
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" onclick="this.nextElementSibling.classList.toggle('show')">
                                <i class="ri-filter-3-line me-1"></i>
                                {% if selected_type %}
                                    {{ selected_type|title }}
                                {% else %}
                                    All Types
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="?">All Types</a></li>
                                {% for type_code, type_name in setting_types %}
                                <li><a class="dropdown-item" href="?type={{ type_code }}">{{ type_name }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <form method="GET" class="d-flex">
                            {% if selected_type %}
                            <input type="hidden" name="type" value="{{ selected_type }}">
                            {% endif %}
                            <div class="input-group">
                                <input type="text" class="form-control" name="search" placeholder="Search configurations..." value="{{ search_query }}">
                                <button class="btn btn-outline-secondary" type="submit">
                                    <i class="ri-search-line"></i>
                                </button>
                            </div>
                        </form>
                        
                        {% if can_bulk_edit %}
                        <a href="{% url 'accounts:system_config' action='bulk' %}" class="btn btn-outline-info">
                            <i class="ri-edit-box-line me-1"></i>Bulk Edit
                        </a>
                        {% endif %}
                        
                        {% if can_export %}
                        <a href="{% url 'accounts:system_config' action='export' %}{% if selected_type %}?type={{ selected_type }}{% endif %}" class="btn btn-outline-success">
                            <i class="ri-download-line me-1"></i>Export
                        </a>
                        {% endif %}
                        
                        {% if can_add_setting %}
                        <a href="{% url 'accounts:system_config' action='create' %}" class="btn btn-primary">
                            <i class="ri-add-line me-1"></i>Add Configuration
                        </a>
                        {% endif %}
                        
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="dropdown" onclick="this.nextElementSibling.classList.toggle('show')">
                                <i class="ri-more-line"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="{% url 'accounts:system_config' action='statistics' %}">
                                    <i class="ri-bar-chart-line me-2"></i>Statistics
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'accounts:system_config' action='maintenance' %}">
                                    <i class="ri-tools-line me-2"></i>Maintenance
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'accounts:system_config' action='import' %}">
                                    <i class="ri-upload-line me-2"></i>Import
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="resetToDefaults()">
                                    <i class="ri-refresh-line me-2"></i>Reset to Defaults
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body">
                {% if configurations %}
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p class="text-muted mb-0">
                            <i class="ri-settings-3-line me-1"></i>
                            Showing {{ configurations|length }} of {{ total_configs }} configurations
                        </p>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="view-mode" id="card-view" checked>
                            <label class="btn btn-outline-secondary" for="card-view">
                                <i class="ri-layout-grid-line"></i>
                            </label>
                            <input type="radio" class="btn-check" name="view-mode" id="list-view">
                            <label class="btn btn-outline-secondary" for="list-view">
                                <i class="ri-list-check"></i>
                            </label>
                        </div>
                    </div>
                </div>
            
                <script>
                document.getElementById('card-view').addEventListener('change', function() {
                    if (this.checked) {
                        document.getElementById('card-view-content').style.display = 'block';
                        document.getElementById('list-view-content').style.display = 'none';
                    }
                });
            
                document.getElementById('list-view').addEventListener('change', function() {
                    if (this.checked) {
                        document.getElementById('card-view-content').style.display = 'none';
                        document.getElementById('list-view-content').style.display = 'block';
                    }
                });
            
                document.addEventListener('DOMContentLoaded', function() {
                    var dropdownElementList = [].slice.call(document.querySelectorAll('[data-bs-toggle="dropdown"]'));
                    var dropdownList = dropdownElementList.map(function (dropdownToggleEl) {
                        return new bootstrap.Dropdown(dropdownToggleEl);
                    });
                });
                </script>
            
                <div id="card-view-content">
                    {% for setting_type, configs in grouped_configs.items %}
                    <div class="mb-4">
                        <div class="d-flex align-items-center mb-3">
                            <h5 class="mb-0 me-2">
                                {% for type_code, type_name in setting_types %}
                                    {% if type_code == setting_type %}{{ type_name }}{% endif %}
                                {% endfor %}
                            </h5>
                            <span class="badge bg-primary-subtle text-primary">{{ configs|length }}</span>
                        </div>
                        
                        <div class="row">
                            {% for config in configs %}
                            <div class="col-xl-4 col-lg-6 col-md-6 mb-3">
                                <div class="card config-card {{ config.setting_type|lower }} h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <span class="badge setting-type-badge bg-{{ config.setting_type|lower }}-subtle text-{{ config.setting_type|lower }}">
                                                {{ config.get_setting_type_display }}
                                            </span>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-outline-secondary border-0" type="button" data-bs-toggle="dropdown">
                                                    <i class="ri-more-line"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li><a class="dropdown-item" href="{% url 'accounts:system_config' action='detail' config_id=config.id %}">
                                                        <i class="ri-eye-line me-2"></i>View Details
                                                    </a></li>
                                                    <li><a class="dropdown-item" href="{% url 'accounts:system_config' action='edit' config_id=config.id %}">
                                                        <i class="ri-edit-line me-2"></i>Edit
                                                    </a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteConfig({{ config.id }}, '{{ config.key }}')">
                                                        <i class="ri-delete-bin-line me-2"></i>Delete
                                                    </a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <h6 class="card-title mb-2">{{ config.get_display_name }}</h6>
                                        
                                        <div class="config-value mb-2">
                                            {% if config.value|length > 50 %}
                                                {{ config.value|truncatechars:50 }}
                                            {% else %}
                                                {{ config.value }}
                                            {% endif %}
                                        </div>
                                        
                                        {% if config.description %}
                                        <p class="text-muted small mb-2">{{ config.description|truncatechars:80 }}</p>
                                        {% endif %}
                                        
                                        <div class="d-flex justify-content-between align-items-center text-muted small">
                                            <span>
                                                <i class="ri-time-line me-1"></i>
                                                {{ config.updated_at|date:"M d, Y" }}
                                            </span>
                                            {% if config.updated_by %}
                                            <span>
                                                <i class="ri-user-line me-1"></i>
                                                {{ config.updated_by.get_full_name|default:config.updated_by.username }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div id="list-view-content" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for config in configurations %}
                                <tr>
                                    <td>
                                        <strong>{{ config.get_display_name }}</strong>
                                    </td>
                                    <td>
                                        <code class="small">
                                            {% if config.value|length > 30 %}
                                                {{ config.value|truncatechars:30 }}
                                            {% else %}
                                                {{ config.value }}
                                            {% endif %}
                                        </code>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ config.setting_type|lower }}-subtle text-{{ config.setting_type|lower }}">
                                            {{ config.get_setting_type_display }}
                                        </span>
                                    </td>
                                    <td class="text-muted small">
                                        {{ config.description|truncatechars:50|default:"-" }}
                                    </td>
                                    <td class="text-muted small">
                                        {{ config.updated_at|date:"M d, Y" }}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'accounts:system_config' action='detail' config_id=config.id %}" class="btn btn-outline-primary btn-sm">
                                                <i class="ri-eye-line"></i>
                                            </a>
                                            <a href="{% url 'accounts:system_config' action='edit' config_id=config.id %}" class="btn btn-outline-secondary btn-sm">
                                                <i class="ri-edit-line"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <i class="ri-settings-3-line display-4 text-muted"></i>
                    <h5 class="mt-3">No configurations found</h5>
                    <p class="text-muted">
                        {% if search_query %}
                            No configurations match your search criteria.
                        {% else %}
                            Start by creating your first system configuration.
                        {% endif %}
                    </p>
                    {% if can_add_setting %}
                    <a href="{% url 'accounts:system_config' action='create' %}" class="btn btn-primary">
                        <i class="ri-add-line me-1"></i>Add Configuration
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% if action == 'detail' %}
{% with title_sub="System Administration" title="Configuration Details" %}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">{{ configuration.key }}</h4>
                        <p class="text-muted mb-0">Configuration Details</p>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="{% url 'accounts:system_config' %}" class="btn btn-outline-secondary">
                            <i class="ri-arrow-left-line me-1"></i>Back to List
                        </a>
                        {% if can_edit %}
                        <a href="{% url 'accounts:system_config' action='edit' config_id=configuration.id %}" class="btn btn-primary">
                            <i class="ri-edit-line me-1"></i>Edit Configuration
                        </a>
                        {% endif %}
                        {% if can_delete %}
                        <button class="btn btn-outline-danger" onclick="deleteConfig({{ configuration.id }}, '{{ configuration.key }}')">
                            <i class="ri-delete-bin-line me-1"></i>Delete
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted small">Configuration Key</label>
                                        <div class="fw-bold">{{ configuration.key }}</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted small">Setting Type</label>
                                        <div>
                                            <span class="badge bg-{{ configuration.setting_type|lower }}-subtle text-{{ configuration.setting_type|lower }}">
                                                {{ configuration.get_setting_type_display }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="col-12 mb-3">
                                        <label class="form-label text-muted small">Current Value</label>
                                        <div class="config-value">{{ configuration.value }}</div>
                                    </div>
                                    {% if configuration.description %}
                                    <div class="col-12 mb-3">
                                        <label class="form-label text-muted small">Description</label>
                                        <div>{{ configuration.description }}</div>
                                    </div>
                                    {% endif %}
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted small">Status</label>
                                        <div>
                                            {% if configuration.is_active %}
                                                <span class="badge bg-success-subtle text-success">
                                                    <i class="ri-check-line me-1"></i>Active
                                                </span>
                                            {% else %}
                                                <span class="badge bg-danger-subtle text-danger">
                                                    <i class="ri-close-line me-1"></i>Inactive
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label text-muted small">Encrypted</label>
                                        <div>
                                            {% if configuration.is_encrypted %}
                                                <span class="badge bg-warning-subtle text-warning">
                                                    <i class="ri-lock-line me-1"></i>Yes
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary-subtle text-secondary">
                                                    <i class="ri-lock-unlock-line me-1"></i>No
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h5 class="mb-0">Audit Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-muted small">Created At</label>
                                            <div>{{ configuration.created_at|date:"F d, Y g:i A" }}</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-muted small">Last Updated</label>
                                            <div>{{ configuration.updated_at|date:"F d, Y g:i A" }}</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        {% if configuration.updated_by %}
                                        <div class="mb-3">
                                            <label class="form-label text-muted small">Updated By</label>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar avatar-sm me-2">
                                                    <span class="avatar-title bg-primary-subtle text-primary rounded-circle">
                                                        {{ configuration.updated_by.first_name|first }}{{ configuration.updated_by.last_name|first }}
                                                    </span>
                                                </div>
                                                <div>
                                                    <div class="fw-medium">{{ configuration.updated_by.get_full_name }}</div>
                                                    <div class="text-muted small">{{ configuration.updated_by.employee_code }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        {% if related_configs %}
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Related Configurations</h6>
                            </div>
                            <div class="card-body">
                                {% for related in related_configs %}
                                <div class="d-flex align-items-center mb-3">
                                    <div class="flex-grow-1">
                                        <div class="fw-medium">{{ related.key }}</div>
                                        <div class="text-muted small">{{ related.value|truncatechars:30 }}</div>
                                    </div>
                                    <a href="{% url 'accounts:system_config' action='detail' config_id=related.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="ri-eye-line"></i>
                                    </a>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if audit_logs %}
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0">Recent Changes</h6>
                            </div>
                            <div class="card-body">
                                {% for log in audit_logs %}
                                <div class="d-flex align-items-start mb-3">
                                    <div class="avatar avatar-sm me-2">
                                        <span class="avatar-title bg-{{ log.action|lower }}-subtle text-{{ log.action|lower }} rounded-circle">
                                            {% if log.action == 'CREATE' %}
                                                <i class="ri-add-line"></i>
                                            {% elif log.action == 'UPDATE' %}
                                                <i class="ri-edit-line"></i>
                                            {% elif log.action == 'DELETE' %}
                                                <i class="ri-delete-bin-line"></i>
                                            {% else %}
                                                <i class="ri-settings-line"></i>
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-medium">{{ log.get_action_display }}</div>
                                        <div class="text-muted small">{{ log.timestamp|date:"M d, Y g:i A" }}</div>
                                        {% if log.user %}
                                        <div class="text-muted small">by {{ log.user.get_full_name }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% if action == 'create' or action == 'edit' %}
{% with title_sub="System Administration" title=form_title|default:"Configuration Form" %}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">
                            {% if is_update %}
                                Edit Configuration
                            {% else %}
                                Add New Configuration
                            {% endif %}
                        </h4>
                        <p class="text-muted mb-0">
                            {% if is_update %}
                                Update system configuration settings
                            {% else %}
                                Create a new system configuration
                            {% endif %}
                        </p>
                    </div>
                    <a href="{% url 'accounts:system_config' %}" class="btn btn-outline-secondary">
                        <i class="ri-arrow-left-line me-1"></i>Back to List
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.key.id_for_label }}" class="form-label">
                                                Configuration Key <span class="text-danger">*</span>
                                            </label>
                                            {{ form.key }}
                                            {% if form.key.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.key.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">Unique identifier for this configuration (uppercase, alphanumeric)</div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.setting_type.id_for_label }}" class="form-label">
                                                Setting Type <span class="text-danger">*</span>
                                            </label>
                                            {{ form.setting_type }}
                                            {% if form.setting_type.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.setting_type.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">Category of this configuration setting</div>
                                        </div>
                                        
                                        <div class="col-12 mb-3">
                                            <label for="{{ form.value.id_for_label }}" class="form-label">
                                                Configuration Value <span class="text-danger">*</span>
                                            </label>
                                            {{ form.value }}
                                            {% if form.value.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.value.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">The actual value for this configuration</div>
                                        </div>
                                        
                                        <div class="col-12 mb-3">
                                            <label for="{{ form.description.id_for_label }}" class="form-label">
                                                Description
                                            </label>
                                            {{ form.description }}
                                            {% if form.description.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.description.errors.0 }}
                                                </div>
                                            {% endif %}
                                            <div class="form-text">Optional description explaining this configuration</div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check form-switch">
                                                {{ form.is_active }}
                                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                                    Active Configuration
                                                </label>
                                            </div>
                                            <div class="form-text">Enable or disable this configuration</div>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <div class="form-check form-switch">
                                                {{ form.is_encrypted }}
                                                <label class="form-check-label" for="{{ form.is_encrypted.id_for_label }}">
                                                    Encrypted Value
                                                </label>
                                            </div>
                                            <div class="form-text">Mark if this value contains sensitive data</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card border-0 bg-primary-subtle">
                                <div class="card-body">
                                    <h6 class="text-primary mb-3">
                                        <i class="ri-information-line me-1"></i>Configuration Guidelines
                                    </h6>
                                    
                                    <div class="mb-3">
                                        <h6 class="small text-primary">Key Format:</h6>
                                        <ul class="small text-muted mb-0">
                                            <li>Use UPPERCASE letters</li>
                                            <li>Separate words with underscores</li>
                                            <li>Be descriptive and clear</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="small text-primary">Value Types:</h6>
                                        <ul class="small text-muted mb-0">
                                            <li>Boolean: true/false</li>
                                            <li>Numbers: 123, 45.67</li>
                                            <li>Time: HH:MM:SS format</li>
                                            <li>Text: Any string value</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <h6 class="small text-primary">Setting Types:</h6>
                                        <ul class="small text-muted mb-0">
                                            <li><strong>SYSTEM:</strong> Core system settings</li>
                                            <li><strong>SECURITY:</strong> Authentication & access</li>
                                            <li><strong>ATTENDANCE:</strong> Time tracking rules</li>
                                            <li><strong>PAYROLL:</strong> Salary calculations</li>
                                            <li><strong>LEAVE:</strong> Leave management</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-end gap-2">
                                <a href="{% url 'accounts:system_config' %}" class="btn btn-outline-secondary">
                                    <i class="ri-close-line me-1"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="ri-save-line me-1"></i>
                                    {% if is_update %}Update Configuration{% else %}Create Configuration{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% elif action == 'statistics' %}
{% with title_sub="System Administration" title="System Statistics" %}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="avatar-lg bg-primary-subtle text-primary rounded me-3">
                        <i class="ri-settings-3-line fs-22"></i>
                    </div>
                    <div>
                        <p class="text-muted mb-1">Total Configurations</p>
                        <h4 class="mb-0">{{ config_stats.total_configs }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="avatar-lg bg-success-subtle text-success rounded me-3">
                        <i class="ri-user-settings-line fs-22"></i>
                    </div>
                    <div>
                        <p class="text-muted mb-1">Active Sessions</p>
                        <h4 class="mb-0">{{ active_sessions }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="avatar-lg bg-warning-subtle text-warning rounded me-3">
                        <i class="ri-time-line fs-22"></i>
                    </div>
                    <div>
                        <p class="text-muted mb-1">Recently Updated</p>
                        <h4 class="mb-0">{{ config_stats.recently_updated }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6">
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="avatar-lg bg-danger-subtle text-danger rounded me-3">
                        <i class="ri-key-line fs-22"></i>
                    </div>
                    <div>
                        <p class="text-muted mb-1">Password Expiring</p>
                        <h4 class="mb-0">{{ password_expiry_users }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Configuration Distribution by Type</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for type_name, count in config_stats.by_type.items %}
                    <div class="col-md-6 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-medium">{{ type_name }}</span>
                            <span class="badge bg-primary-subtle text-primary">{{ count }}</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" style="width: {% widthratio count config_stats.total_configs 100 %}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Recent Configuration Changes</h5>
            </div>
            <div class="card-body">
                {% if recent_activities %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Action</th>
                                <th>Configuration</th>
                                <th>User</th>
                                <th>Timestamp</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in recent_activities %}
                            <tr>
                                <td>
                                    <span class="badge bg-{{ activity.action|lower }}-subtle text-{{ activity.action|lower }}">
                                        {{ activity.get_action_display }}
                                    </span>
                                </td>
                                <td class="fw-medium">{{ activity.object_repr|default:"-" }}</td>
                                <td>
                                    {% if activity.user %}
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-xs me-2">
                                                <span class="avatar-title bg-primary-subtle text-primary rounded-circle">
                                                    {{ activity.user.first_name|first }}{{ activity.user.last_name|first }}
                                                </span>
                                            </div>
                                            {{ activity.user.get_full_name }}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">System</span>
                                    {% endif %}
                                </td>
                                <td class="text-muted">{{ activity.timestamp|date:"M d, Y g:i A" }}</td>
                                <td class="text-muted small">{{ activity.ip_address|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="ri-history-line display-4 text-muted"></i>
                    <h6 class="mt-3">No recent activities</h6>
                    <p class="text-muted">Configuration changes will appear here</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'accounts:system_config' action='create' %}" class="btn btn-primary">
                        <i class="ri-add-line me-1"></i>Add Configuration
                    </a>
                    <a href="{% url 'accounts:system_config' action='bulk' %}" class="btn btn-outline-info">
                        <i class="ri-edit-box-line me-1"></i>Bulk Operations
                    </a>
                    <a href="{% url 'accounts:system_config' action='export' %}" class="btn btn-outline-success">
                        <i class="ri-download-line me-1"></i>Export All
                    </a>
                    <a href="{% url 'accounts:system_config' action='maintenance' %}" class="btn btn-outline-warning">
                        <i class="ri-tools-line me-1"></i>Maintenance
                    </a>
                </div>
                
                <!-- DEBUG INFO -->
                <div class="mt-3 p-2 bg-light small">
                    <p>DEBUG: can_add_setting = {{ can_add_setting }}</p>
                    <p>DEBUG: configurations count = {{ configurations.count }}</p>
                    <p>DEBUG: action = {{ action }}</p>
                    <p>DEBUG: total_configs = {{ total_configs }}</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">System Health</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="fw-bold text-success fs-4">{{ config_stats.total_configs }}</div>
                        <div class="small text-muted">Total Configs</div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="fw-bold text-info fs-4">{{ active_sessions }}</div>
                        <div class="small text-muted">Active Sessions</div>
                    </div>
                    <div class="col-6">
                        <div class="fw-bold text-warning fs-4">{{ config_stats.recently_updated }}</div>
                        <div class="small text-muted">Recent Updates</div>
                    </div>
                    <div class="col-6">
                        <div class="fw-bold text-danger fs-4">{{ password_expiry_users }}</div>
                        <div class="small text-muted">Expiring Passwords</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% elif action == 'maintenance' %}
{% with title_sub="System Administration" title="System Maintenance" %}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">System Maintenance</h4>
                        <p class="text-muted mb-0">Perform system cleanup and maintenance tasks</p>
                    </div>
                    <a href="{% url 'accounts:system_config' %}" class="btn btn-outline-secondary">
                        <i class="ri-arrow-left-line me-1"></i>Back to Configuration
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card border-warning">
                            <div class="card-header bg-warning-subtle">
                                <h5 class="mb-0 text-warning">
                                    <i class="ri-database-2-line me-2"></i>Database Cleanup
                                </h5>
                            </div>
                            <div class="card-body">
                                <form method="post">
                                    {% csrf_token %}
                                    
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <h6 class="mb-1">Expired Sessions</h6>
                                                <p class="text-muted small mb-0">Clean up expired user sessions from database</p>
                                            </div>
                                            <span class="badge bg-warning-subtle text-warning fs-6">{{ expired_sessions_count }}</span>
                                        </div>
                                        <button type="submit" name="action" value="cleanup_sessions" class="btn btn-warning w-100">
                                            <i class="ri-delete-bin-line me-1"></i>Cleanup Expired Sessions
                                        </button>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <h6 class="mb-1">Password Reset Tokens</h6>
                                                <p class="text-muted small mb-0">Remove expired password reset tokens</p>
                                            </div>
                                            <span class="badge bg-warning-subtle text-warning fs-6">{{ expired_tokens_count }}</span>
                                        </div>
                                        <button type="submit" name="action" value="cleanup_tokens" class="btn btn-warning w-100">
                                            <i class="ri-delete-bin-line me-1"></i>Cleanup Reset Tokens
                                        </button>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <h6 class="mb-1">Old Audit Logs</h6>
                                                <p class="text-muted small mb-0">Archive old audit log entries</p>
                                            </div>
                                            <span class="badge bg-warning-subtle text-warning fs-6">{{ old_logs_count }}</span>
                                        </div>
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">Keep logs for</span>
                                            <input type="number" class="form-control" name="days" value="365" min="30" max="3650">
                                            <span class="input-group-text">days</span>
                                        </div>
                                        <button type="submit" name="action" value="cleanup_logs" class="btn btn-warning w-100">
                                            <i class="ri-delete-bin-line me-1"></i>Cleanup Old Logs
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="card border-info">
                            <div class="card-header bg-info-subtle">
                                <h5 class="mb-0 text-info">
                                    <i class="ri-notification-line me-2"></i>Notifications & Alerts
                                </h5>
                            </div>
                            <div class="card-body">
                                <form method="post">
                                    {% csrf_token %}
                                    
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <h6 class="mb-1">Password Expiry Notifications</h6>
                                                <p class="text-muted small mb-0">Send notifications to users with expiring passwords</p>
                                            </div>
                                            <span class="badge bg-info-subtle text-info fs-6">{{ password_expiry_users_count }}</span>
                                        </div>
                                        <button type="submit" name="action" value="send_password_notifications" class="btn btn-info w-100">
                                            <i class="ri-mail-send-line me-1"></i>Send Password Notifications
                                        </button>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <div class="mb-2">
                                            <h6 class="mb-1">Email Connection Test</h6>
                                            <p class="text-muted small mb-0">Test email server connectivity and configuration</p>
                                        </div>
                                        <button type="submit" name="action" value="test_email" class="btn btn-info w-100">
                                            <i class="ri-mail-check-line me-1"></i>Test Email Connection
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card border-success mt-4">
                            <div class="card-header bg-success-subtle">
                                <h5 class="mb-0 text-success">
                                    <i class="ri-bar-chart-line me-2"></i>System Status
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-6 mb-3">
                                        <div class="fw-bold text-success fs-3">{{ total_configs }}</div>
                                        <div class="small text-muted">Total Configurations</div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="fw-bold text-success fs-3">{{ active_sessions }}</div>
                                        <div class="small text-muted">Active Sessions</div>
                                    </div>
                                </div>
                                <hr>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">System Health</span>
                                    <span class="badge bg-success-subtle text-success">Excellent</span>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-success" style="width: 95%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-danger">
                            <div class="card-header bg-danger-subtle">
                                <h5 class="mb-0 text-danger">
                                    <i class="ri-alert-line me-2"></i>Danger Zone
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <h6 class="text-danger">Reset All Configurations</h6>
                                            <p class="text-muted small">This will reset all configurations to their default values. This action cannot be undone.</p>
                                            <button type="button" class="btn btn-outline-danger" onclick="confirmResetDefaults()">
                                                <i class="ri-refresh-line me-1"></i>Reset to Defaults
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <h6 class="text-danger">Clear All Cache</h6>
                                            <p class="text-muted small">Clear all system cache and force reload of configurations.</p>
                                            <form method="post" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" name="action" value="clear_cache" class="btn btn-outline-danger">
                                                    <i class="ri-delete-bin-line me-1"></i>Clear Cache
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% elif action == 'bulk' %}
{% with title_sub="System Administration" title="Bulk Operations" %}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">Bulk Configuration Management</h4>
                        <p class="text-muted mb-0">Perform bulk operations on multiple configurations</p>
                    </div>
                    <a href="{% url 'accounts:system_config' %}" class="btn btn-outline-secondary">
                        <i class="ri-arrow-left-line me-1"></i>Back to List
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="ri-filter-line me-1"></i>
                                {% if selected_type %}{{ selected_type|title }} Settings{% else %}All Types{% endif %}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="?">All Types</a></li>
                                {% for type_code, type_name in setting_types %}
                                <li><a class="dropdown-item" href="?type={{ type_code }}">{{ type_name }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-outline-success" onclick="selectAll()">
                            <i class="ri-checkbox-multiple-line me-1"></i>Select All
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearSelection()">
                            <i class="ri-checkbox-blank-line me-1"></i>Clear Selection
                        </button>
                    </div>
                </div>
                
                <form method="post" id="bulk-operations-form">
                    {% csrf_token %}
                    
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card bg-light border-0">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">Bulk Action</label>
                                            <select name="bulk_action" class="form-select" required>
                                                <option value="">Select Action</option>
                                                <option value="delete">Delete Selected</option>
                                                <option value="update_type">Change Setting Type</option>
                                                <option value="activate">Activate Selected</option>
                                                <option value="deactivate">Deactivate Selected</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6" id="new-type-container" style="display: none;">
                                            <label class="form-label">New Setting Type</label>
                                            <select name="new_setting_type" class="form-select">
                                                {% for type_code, type_name in setting_types %}
                                                <option value="{{ type_code }}">{{ type_name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid h-100">
                                <button type="submit" class="btn btn-primary btn-lg" disabled id="bulk-submit-btn">
                                    <i class="ri-play-line me-1"></i>Execute Bulk Action
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="select-all-checkbox">
                                        </div>
                                    </th>
                                    <th>Configuration Key</th>
                                    <th>Value</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for config in configurations %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input config-checkbox" type="checkbox" name="config_ids" value="{{ config.id }}">
                                        </div>
                                    </td>
                                    <td>
                                        <div class="fw-medium">{{ config.get_display_name }}</div>
                                        {% if config.description %}
                                        <div class="text-muted small">{{ config.description|truncatechars:50 }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <code class="small">
                                            {% if config.value|length > 30 %}
                                                {{ config.value|truncatechars:30 }}
                                            {% else %}
                                                {{ config.value }}
                                            {% endif %}
                                        </code>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ config.setting_type|lower }}-subtle text-{{ config.setting_type|lower }}">
                                            {{ config.get_setting_type_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if config.is_active %}
                                            <span class="badge bg-success-subtle text-success">
                                                <i class="ri-check-line me-1"></i>Active
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger-subtle text-danger">
                                                <i class="ri-close-line me-1"></i>Inactive
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-muted small">
                                        {{ config.updated_at|date:"M d, Y" }}
                                        {% if config.updated_by %}
                                        <br><span class="text-muted">by {{ config.updated_by.get_full_name }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{% url 'accounts:system_config' action='detail' config_id=config.id %}" class="btn btn-outline-primary btn-sm">
                                                <i class="ri-eye-line"></i>
                                            </a>
                                            <a href="{% url 'accounts:system_config' action='edit' config_id=config.id %}" class="btn btn-outline-secondary btn-sm">
                                                <i class="ri-edit-line"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-4">
                                        <i class="ri-settings-3-line display-4 text-muted"></i>
                                        <h6 class="mt-3">No configurations found</h6>
                                        <p class="text-muted">No configurations match the selected criteria</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% elif action == 'import' %}
{% with title_sub="System Administration" title="Import Configuration" %}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-1">Import System Configuration</h4>
                        <p class="text-muted mb-0">Import configurations from JSON file</p>
                    </div>
                    <a href="{% url 'accounts:system_config' %}" class="btn btn-outline-secondary">
                        <i class="ri-arrow-left-line me-1"></i>Back to Configuration
                    </a>
                </div>
            </div>
            
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <form method="post" enctype="multipart/form-data" id="import-form">
                                    {% csrf_token %}
                                    
                                    <div class="mb-4">
                                        <label for="config_file" class="form-label">
                                            <i class="ri-file-upload-line me-1"></i>Select Configuration File
                                        </label>
                                        <input type="file" class="form-control" id="config_file" name="config_file" accept=".json" required>
                                        <div class="form-text">Upload a JSON file containing configuration data</div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="overwrite_existing" name="overwrite_existing" checked>
                                            <label class="form-check-label" for="overwrite_existing">
                                                Overwrite existing configurations
                                            </label>
                                        </div>
                                        <div class="form-text">If unchecked, existing configurations will be skipped</div>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="validate_only" name="validate_only">
                                            <label class="form-check-label" for="validate_only">
                                                Validate only (don't import)
                                            </label>
                                        </div>
                                        <div class="form-text">Check file format and data without importing</div>
                                    </div>
                                    
                                    <div class="d-grid">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="ri-upload-line me-1"></i>Import Configuration
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card border-info">
                            <div class="card-header bg-info-subtle">
                                <h5 class="mb-0 text-info">
                                    <i class="ri-information-line me-2"></i>Import Guidelines
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <h6 class="text-info">File Format</h6>
                                    <ul class="small text-muted mb-0">
                                        <li>JSON format only</li>
                                        <li>Maximum file size: 10MB</li>
                                        <li>UTF-8 encoding required</li>
                                    </ul>
                                </div>
                                
                                <div class="mb-3">
                                    <h6 class="text-info">Required Fields</h6>
                                    <ul class="small text-muted mb-0">
                                        <li>key (unique identifier)</li>
                                        <li>value (configuration value)</li>
                                        <li>setting_type (valid type)</li>
                                    </ul>
                                </div>
                                
                                <div class="mb-3">
                                    <h6 class="text-info">Optional Fields</h6>
                                    <ul class="small text-muted mb-0">
                                        <li>description</li>
                                        <li>is_encrypted</li>
                                        <li>is_active</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card border-success mt-3">
                            <div class="card-header bg-success-subtle">
                                <h5 class="mb-0 text-success">
                                    <i class="ri-download-line me-2"></i>Sample Format
                                </h5>
                            </div>
                            <div class="card-body">
                                <pre class="small text-muted mb-3"><code>{
  "configurations": [
    {
      "key": "WORK_START_TIME",
      "value": "08:00:00",
      "setting_type": "ATTENDANCE",
      "description": "Standard work start time",
      "is_active": true,
      "is_encrypted": false
    }
  ]
}</code></pre>
                                <a href="{% url 'accounts:system_config' action='export' %}?sample=true" class="btn btn-sm btn-success w-100">
                                    <i class="ri-download-line me-1"></i>Download Sample
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the configuration <strong id="delete-config-name"></strong>?</p>
                <p class="text-danger small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" id="delete-form" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Configuration</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="resetDefaultsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Reset to Defaults</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="ri-alert-line me-2"></i>
                    <strong>Warning!</strong> This will reset ALL configurations to their default values.
                </div>
                <p>This action will:</p>
                <ul>
                    <li>Reset all configuration values to system defaults</li>
                    <li>Remove any custom configurations</li>
                    <li>Cannot be undone</li>
                </ul>
                <p>Type <strong>RESET</strong> to confirm:</p>
                <input type="text" class="form-control" id="reset-confirmation" placeholder="Type RESET to confirm">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" id="reset-form" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" name="action" value="reset_defaults" class="btn btn-danger" id="reset-submit-btn" disabled>
                        Reset to Defaults
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'assets/libs/choices.js/public/assets/scripts/choices.min.js' %}"></script>
<script src="{% static 'assets/libs/dragula/dragula.min.js' %}"></script>
<script src="{% static 'assets/js/app/kanban.init.js' %}"></script>
<script src="{% static 'assets/js/app.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('.form-select:not([multiple])');
    selects.forEach(select => {
        if (!select.hasAttribute('data-choices-init')) {
            new Choices(select, {
                searchEnabled: false,
                itemSelectText: '',
            });
            select.setAttribute('data-choices-init', 'true');
        }
    });

    const cardViewBtn = document.getElementById('card-view');
    const listViewBtn = document.getElementById('list-view');
    const cardViewContent = document.getElementById('card-view-content');
    const listViewContent = document.getElementById('list-view-content');

    if (cardViewBtn && listViewBtn && cardViewContent && listViewContent) {
        cardViewBtn.addEventListener('change', function() {
            if (this.checked) {
                cardViewContent.style.display = 'block';
                listViewContent.style.display = 'none';
            }
        });

        listViewBtn.addEventListener('change', function() {
            if (this.checked) {
                cardViewContent.style.display = 'none';
                listViewContent.style.display = 'block';
            }
        });
    }

    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const configCheckboxes = document.querySelectorAll('.config-checkbox');
    const bulkSubmitBtn = document.getElementById('bulk-submit-btn');
    const bulkActionSelect = document.querySelector('select[name="bulk_action"]');
    const newTypeContainer = document.getElementById('new-type-container');

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            configCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkSubmitButton();
        });
    }

    configCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkSubmitButton);
    });

    if (bulkActionSelect) {
        bulkActionSelect.addEventListener('change', function() {
            if (this.value === 'update_type') {
                newTypeContainer.style.display = 'block';
            } else {
                newTypeContainer.style.display = 'none';
            }
            updateBulkSubmitButton();
        });
    }

    function updateBulkSubmitButton() {
        const checkedBoxes = document.querySelectorAll('.config-checkbox:checked');
        const hasAction = bulkActionSelect && bulkActionSelect.value;
        
        if (bulkSubmitBtn) {
            bulkSubmitBtn.disabled = checkedBoxes.length === 0 || !hasAction;
        }
    }

    const forms = document.querySelectorAll('.needs-validation');
    forms.forEach(form => {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    });

    const resetConfirmation = document.getElementById('reset-confirmation');
    const resetSubmitBtn = document.getElementById('reset-submit-btn');

    if (resetConfirmation && resetSubmitBtn) {
        resetConfirmation.addEventListener('input', function() {
            resetSubmitBtn.disabled = this.value !== 'RESET';
        });
    }

    const fileInput = document.getElementById('config_file');
    if (fileInput) {
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB');
                    this.value = '';
                    return;
                }
                
                if (!file.name.toLowerCase().endsWith('.json')) {
                    alert('Please select a JSON file');
                    this.value = '';
                    return;
                }
            }
        });
    }

    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => {
        new bootstrap.Tooltip(tooltip);
    });
});

function deleteConfig(configId, configName) {
    document.getElementById('delete-config-name').textContent = configName;
    document.getElementById('delete-form').action = `/accounts/system-config/delete/${configId}/`;
    new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
}

function confirmResetDefaults() {
    new bootstrap.Modal(document.getElementById('resetDefaultsModal')).show();
}

function selectAll() {
    document.querySelectorAll('.config-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateBulkSubmitButton();
}

function clearSelection() {
    document.querySelectorAll('.config-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    document.getElementById('select-all-checkbox').checked = false;
    updateBulkSubmitButton();
}

function updateBulkSubmitButton() {
    const checkedBoxes = document.querySelectorAll('.config-checkbox:checked');
    const bulkActionSelect = document.querySelector('select[name="bulk_action"]');
    const bulkSubmitBtn = document.getElementById('bulk-submit-btn');
    
    if (bulkSubmitBtn) {
        bulkSubmitBtn.disabled = checkedBoxes.length === 0 || !bulkActionSelect.value;
    }
}

{% if action == 'statistics' %}
setInterval(function() {
    if (document.visibilityState === 'visible') {
        fetch(window.location.href, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            const statsCards = document.querySelectorAll('.card-body h4');
            const newStatsCards = doc.querySelectorAll('.card-body h4');
            
            statsCards.forEach((card, index) => {
                if (newStatsCards[index]) {
                    card.textContent = newStatsCards[index].textContent;
                }
            });
        })
        .catch(error => console.log('Auto-refresh failed:', error));
    }
}, 30000);
{% endif %}
</script>
{% endblock %}
