{% extends "partials/layouts/main.html" %}
{% load static %}

{% include "partials/main.html" %}
{% block meta %}
{% with title=page_title %}
{% include "partials/title-meta.html" %}
{% endwith %}
{% endblock %}
{% block css %}
<link rel="stylesheet" href="/static/assets/libs/gridjs/theme/mermaid.min.css">
{% endblock %}
{% block content %}
{% with title_sub="Payroll" title=page_title %}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <h4 class="card-title mb-0 flex-grow-1">Payroll Period Details</h4>
                <div class="d-flex gap-2">
                    {% if can_edit_period %}
                    <a href="{% url 'payroll:period_update' pk=period.id %}" class="btn btn-soft-primary">
                        <i class="ri-edit-line align-bottom me-1"></i> Edit
                    </a>
                    {% endif %}
                    
                    <div class="action-buttons">
                        {% if can_process_payroll %}
                        <form action="{% url 'payroll:period_process' pk=period.id %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-info" title="Process Payroll">
                                <i class="bi bi-play-fill"></i>
                            </button>
                        </form>
                        {% endif %}
                        
                        {% if period.status == 'PROCESSING' %}
                        <form action="{% url 'payroll:period_complete' pk=period.id %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-success" title="Mark as Completed">
                                <i class="bi bi-check-circle"></i>
                            </button>
                        </form>
                        {% endif %}
                        
                        {% if can_approve_payroll %}
                        <form action="{% url 'payroll:period_approve' pk=period.id %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-success" title="Approve Payroll">
                                <i class="bi bi-check2-all"></i>
                            </button>
                        </form>
                        {% endif %}
                        
                        {% if can_generate_bank_file %}
                        <a href="{% url 'payroll:bank_transfer_create' %}?period={{ period.id }}" class="btn btn-sm btn-outline-primary" title="Generate Bank Transfer">
                            <i class="bi bi-bank"></i>
                        </a>
                        {% endif %}
                        
                        {% if period.status not in 'PAID,CANCELLED' %}
                        <form action="{% url 'payroll:period_cancel' pk=period.id %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Cancel Period">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>                    
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-4">
                            <h5 class="text-muted mb-3">Period Information</h5>
                            <div class="table-responsive">
                                <table class="table table-borderless mb-0">
                                    <tbody>
                                        <tr>
                                            <th scope="row" class="ps-0" style="width: 40%;">Period Name:</th>
                                            <td class="fw-semibold">{{ period.period_name }}</td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">Status:</th>
                                            <td>
                                                {% if period.status == 'DRAFT' %}
                                                <span class="badge bg-warning text-dark">Draft</span>
                                                {% elif period.status == 'PROCESSING' %}
                                                <span class="badge bg-info">Processing</span>
                                                {% elif period.status == 'COMPLETED' %}
                                                <span class="badge bg-primary">Completed</span>
                                                {% elif period.status == 'APPROVED' %}
                                                <span class="badge bg-success">Approved</span>
                                                {% elif period.status == 'PAID' %}
                                                <span class="badge bg-success">Paid</span>
                                                {% elif period.status == 'CANCELLED' %}
                                                <span class="badge bg-danger">Cancelled</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">Start Date:</th>
                                            <td>{{ period.start_date|date:"M d, Y" }}</td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">End Date:</th>
                                            <td>{{ period.end_date|date:"M d, Y" }}</td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">Processing Date:</th>
                                            <td>{{ period.processing_date|date:"M d, Y" }}</td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">Cutoff Date:</th>
                                            <td>{{ period.cutoff_date|date:"M d, Y" }}</td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">Working Days:</th>
                                            <td>{{ period.total_working_days }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-4">
                            <h5 class="text-muted mb-3">Financial Summary</h5>
                            <div class="table-responsive">
                                <table class="table table-borderless mb-0">
                                    <tbody>
                                        <tr>
                                            <th scope="row" class="ps-0" style="width: 40%;">Total Employees:</th>
                                            <td class="fw-semibold">{{ period.total_employees }}</td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">Total Gross Salary:</th>
                                            <td class="fw-semibold">{{ period.total_gross_salary|floatformat:2 }}</td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">Total Deductions:</th>
                                            <td class="fw-semibold">{{ period.total_deductions|floatformat:2 }}</td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">Total Net Salary:</th>
                                            <td class="fw-semibold">{{ period.total_net_salary|floatformat:2 }}</td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">EPF Employee:</th>
                                            <td class="fw-semibold">{{ period.total_epf_employee|floatformat:2 }}</td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">EPF Employer:</th>
                                            <td class="fw-semibold">{{ period.total_epf_employer|floatformat:2 }}</td>
                                        </tr>
                                        <tr>
                                            <th scope="row" class="ps-0">ETF Contribution:</th>
                                            <td class="fw-semibold">{{ period.total_etf_contribution|floatformat:2 }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="mb-4">
                            <h5 class="text-muted mb-3">Payslip Status Summary</h5>
                            <div class="row">
                                <div class="col-md-2">
                                    <div class="card border">
                                        <div class="card-body p-3 text-center">
                                            <h6 class="mb-2">Total</h6>
                                            <h3 class="mb-0 fw-semibold">{{ payslips_count }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card border">
                                        <div class="card-body p-3 text-center">
                                            <h6 class="mb-2">Draft</h6>
                                            <h3 class="mb-0 fw-semibold">{{ payslips_by_status.DRAFT }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card border">
                                        <div class="card-body p-3 text-center">
                                            <h6 class="mb-2">Calculated</h6>
                                            <h3 class="mb-0 fw-semibold">{{ payslips_by_status.CALCULATED }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card border">
                                        <div class="card-body p-3 text-center">
                                            <h6 class="mb-2">Approved</h6>
                                            <h3 class="mb-0 fw-semibold">{{ payslips_by_status.APPROVED }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card border">
                                        <div class="card-body p-3 text-center">
                                            <h6 class="mb-2">Paid</h6>
                                            <h3 class="mb-0 fw-semibold">{{ payslips_by_status.PAID }}</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="card border">
                                        <div class="card-body p-3 text-center">
                                            <h6 class="mb-2">Cancelled</h6>
                                            <h3 class="mb-0 fw-semibold">{{ payslips_by_status.CANCELLED }}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Department Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Department</th>
                                                <th>Employees</th>
                                                <th>Calculated</th>
                                                <th>Approved</th>
                                                <th>Total Gross</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for dept_name, dept_data in department_summaries.items %}
                                            <tr>
                                                <td class="fw-semibold">{{ dept_name }}</td>
                                                <td>{{ dept_data.payslips_count }}</td>
                                                <td>{{ dept_data.calculated_count }}</td>
                                                <td>{{ dept_data.approved_count }}</td>
                                                <td>{{ dept_data.summary.total_gross|floatformat:2 }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center py-3">No department data available</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Role Summary</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Role</th>
                                                <th>Employees</th>
                                                <th>Calculated</th>
                                                <th>Approved</th>
                                                <th>Total Gross</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for role_name, role_data in role_summaries.items %}
                                            <tr>
                                                <td class="fw-semibold">{{ role_name }}</td>
                                                <td>{{ role_data.payslips_count }}</td>
                                                <td>{{ role_data.calculated_count }}</td>
                                                <td>{{ role_data.approved_count }}</td>
                                                <td>{{ role_data.total_gross|floatformat:2 }}</td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="5" class="text-center py-3">No role data available</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if bank_transfers %}
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Bank Transfers</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Reference</th>
                                                <th>Bank</th>
                                                <th>Date</th>
                                                <th>Amount</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for transfer in bank_transfers %}
                                            <tr>
                                                <td class="fw-semibold">
                                                    <a href="{% url 'payroll:bank_transfer_detail' pk=transfer.id %}">
                                                        {{ transfer.reference_number }}
                                                    </a>
                                                </td>
                                                <td>{{ transfer.bank_name }}</td>
                                                <td>{{ transfer.transfer_date|date:"M d, Y" }}</td>
                                                <td>{{ transfer.total_amount|floatformat:2 }}</td>
                                                <td>
                                                    {% if transfer.status == 'DRAFT' %}
                                                    <span class="badge bg-warning text-dark">Draft</span>
                                                    {% elif transfer.status == 'GENERATED' %}
                                                    <span class="badge bg-info">Generated</span>
                                                    {% elif transfer.status == 'SENT' %}
                                                    <span class="badge bg-primary">Sent</span>
                                                    {% elif transfer.status == 'PROCESSED' %}
                                                    <span class="badge bg-success">Processed</span>
                                                    {% elif transfer.status == 'CANCELLED' %}
                                                    <span class="badge bg-danger">Cancelled</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <a href="{% url 'payroll:bank_transfer_detail' pk=transfer.id %}" class="btn btn-sm btn-soft-primary">
                                                        View
                                                    </a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="row mt-4">
                    <div class="col-12 d-flex justify-content-between">
                        <a href="{% url 'payroll:period_list' %}" class="btn btn-light">
                            <i class="ri-arrow-left-line align-bottom me-1"></i> Back to Periods
                        </a>
                        
                        <div class="d-flex gap-2">
                            {% if can_calculate_payslips %}
                            <a href="{% url 'payroll:bulk_calculate' %}?period={{ period.id }}" class="btn btn-primary">
                                <i class="ri-calculator-line align-bottom me-1"></i> Calculate Payslips
                            </a>
                            {% endif %}
                            
                            {% if can_approve_payslips %}
                            <a href="{% url 'payroll:bulk_approve' %}?period={{ period.id }}" class="btn btn-success">
                                <i class="ri-check-double-line align-bottom me-1"></i> Approve Payslips
                            </a>
                            {% endif %}
                            
                            <a href="{% url 'payroll:payslip_list' %}?period={{ period.id }}" class="btn btn-info">
                                <i class="ri-file-list-3-line align-bottom me-1"></i> View Payslips
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block javascript %}
<script src="/static/assets/libs/gridjs/gridjs.umd.js"></script>
{% endblock %}

