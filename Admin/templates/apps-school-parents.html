{% extends "partials/layouts/main.html" %}
{% load static %}

{% include "partials/main.html" %}
{% block meta %}
{% with title="Employee Details" %}
{% include "partials/title-meta.html" %}
{% endwith %}
{% endblock %}
{% block css %}
<link rel="stylesheet" href="/static/assets/libs/choices.js/public/assets/styles/choices.min.css">
{% endblock %}
{% block content %}
{% with title_sub="HR Management" title="Employee Details"%}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-xl-4">
        <div class="card">
            <div class="card-body">
                <div class="text-center">
                    <div class="position-relative d-inline-block">
                        {% if employee.user.profile_picture %}
                            <img src="{{ employee.user.profile_picture.url }}" alt="Employee" class="img-fluid rounded-circle h-120px w-120px object-fit-cover">
                        {% else %}
                            <div class="avatar avatar-xl bg-primary-subtle text-primary rounded-circle d-inline-flex align-items-center justify-content-center fs-24">
                                {{ employee.user.first_name|first }}{{ employee.user.last_name|first }}
                            </div>
                        {% endif %}
                        <span class="position-absolute top-0 end-0">
                            {% if employee.employment_status == 'ACTIVE' %}
                                <span class="badge bg-success rounded-pill">Active</span>
                            {% elif employee.employment_status == 'PROBATION' %}
                                <span class="badge bg-warning rounded-pill">Probation</span>
                            {% elif employee.employment_status == 'CONFIRMED' %}
                                <span class="badge bg-primary rounded-pill">Confirmed</span>
                            {% else %}
                                <span class="badge bg-secondary rounded-pill">{{ employee.employment_status }}</span>
                            {% endif %}
                        </span>
                    </div>
                    <h4 class="mt-3 mb-1">{{ employee.user.get_full_name }}</h4>
                    <p class="text-muted mb-2">{{ employee.user.job_title|default:"N/A" }}</p>
                    <p class="text-muted mb-3">{{ employee.user.employee_code }}</p>
                    
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="p-2">
                                <h5 class="mb-1">{{ years_of_service|default:0 }}</h5>
                                <p class="text-muted mb-0 fs-12">Years of Service</p>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2">
                                <h5 class="mb-1">{{ age|default:"N/A" }}</h5>
                                <p class="text-muted mb-0 fs-12">Age</p>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2">
                                <h5 class="mb-1">{{ probation_days_remaining|default:"N/A" }}</h5>
                                <p class="text-muted mb-0 fs-12">Probation Days</p>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 justify-content-center mt-3">
                        {% if employee and employee.pk %}
                        <a href="{% url 'employee:employee_update' pk=employee.pk %}" class="btn btn-primary btn-sm">
                            <i class="ri-edit-line me-1"></i>Edit Profile
                        </a>
                        {% endif %}
                        <a href="{% url 'employee:employee_list' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="ri-arrow-left-line me-1"></i>Back to List
                        </a>
                    </div>                 
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Contact Information</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-borderless mb-0">
                        <tbody>
                            <tr>
                                <td class="ps-0 fw-medium">Email:</td>
                                <td class="text-muted">{{ employee.user.email }}</td>
                            </tr>
                            <tr>
                                <td class="ps-0 fw-medium">Phone:</td>
                                <td class="text-muted">{{ employee.phone_number|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <td class="ps-0 fw-medium">Address:</td>
                                <td class="text-muted">{{ employee.address|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <td class="ps-0 fw-medium">Emergency Contact:</td>
                                <td class="text-muted">
                                    {% if employee.emergency_contact_name %}
                                        {{ employee.emergency_contact_name }}<br>
                                        <small>{{ employee.emergency_contact_phone|default:"" }}</small>
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Employment Details</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-borderless mb-0">
                        <tbody>
                            <tr>
                                <td class="ps-0 fw-medium">Department:</td>
                                <td class="text-muted">{{ employee.user.department.name|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <td class="ps-0 fw-medium">Role:</td>
                                <td class="text-muted">{{ employee.user.role.display_name|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <td class="ps-0 fw-medium">Manager:</td>
                                <td class="text-muted">{{ employee.user.manager.get_full_name|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <td class="ps-0 fw-medium">Hire Date:</td>
                                <td class="text-muted">{{ employee.user.hire_date|date:"M d, Y"|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <td class="ps-0 fw-medium">Grade Level:</td>
                                <td class="text-muted">{{ employee.get_grade_level_display|default:"N/A" }}</td>
                            </tr>
                            {% if employee.probation_end_date %}
                            <tr>
                                <td class="ps-0 fw-medium">Probation Ends:</td>
                                <td class="text-muted">{{ employee.probation_end_date|date:"M d, Y" }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header">
                <h4>Education Records</h4>
                <div class="d-flex flex-wrap gap-3 ms-auto">
                    <div class="form-icon">
                        <input type="text" class="form-control form-control-icon" id="educationSearch" placeholder="Search education records..." required>
                        <i class="ri-search-2-line text-muted"></i>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-light text-muted dropdown-toggle" type="button" id="sortByDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Sort By
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="sortByDropdown">
                            <li><a class="dropdown-item" href="javascript:void(0)">Latest First</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)">Oldest First</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)">Institution Name</a></li>
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-light text-muted dropdown-toggle" type="button" id="filterByDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Filter By
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="filterByDropdown">
                            <li><a class="dropdown-item" href="javascript:void(0)">All Records</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)">Verified</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)">Pending</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)">Bachelor's</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)">Master's</a></li>
                        </ul>
                    </div>
                    {% if employee and employee.user and employee.user.pk %}
                    <a href="{% url 'employee:education_create_for_employee' employee_id=employee.user.pk %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg me-1"></i>Add Education
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="table-box table-responsive">
                    <table class="table table-hover text-nowrap">
                        <thead class="table-header">
                            <tr>
                                <th scope="col">Institution</th>
                                <th scope="col">Degree</th>
                                <th scope="col">Field of Study</th>
                                <th scope="col">Year</th>
                                <th scope="col">Status</th>
                                <th scope="col" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for education in education_records %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-md avatar-item bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                            <i class="ri-school-line"></i>
                                        </div>
                                        <div>
                                            <span class="fw-medium">{{ education.institution_name }}</span>
                                            <br><small class="text-muted">{{ education.location|default:"" }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary rounded-pill">{{ education.get_degree_type_display }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-light text-body">{{ education.field_of_study }}</span>
                                </td>
                                <td>{{ education.completion_year }}</td>
                                <td>
                                    {% if education.is_verified %}
                                        <span class="badge bg-success rounded-pill">Verified</span>
                                    {% else %}
                                        <span class="badge bg-warning rounded-pill">Pending</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex justify-content-center action-buttons">
                                        <a href="{% url 'employee:education_update' pk=education.pk %}" class="btn icon-btn-sm btn-light-primary">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        {% if not education.is_verified %}
                                        <form method="POST" action="{% url 'employee:verify_education' pk=education.pk %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn icon-btn-sm btn-light-success" title="Verify">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="ri-school-line fs-48"></i>
                                        <p class="mt-2">No education records found</p>
                                        {% if employee and employee.user and employee.user.pk %}
                                        <a href="{% url 'employee:education_create_for_employee' employee_id=employee.user.pk %}" class="btn btn-primary btn-sm">
                                            <i class="ri-add-line me-1"></i>Add First Record
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
        <div class="card mt-4">
            <div class="card-header">
                <h4>Contract History</h4>
                <div class="d-flex flex-wrap gap-3 ms-auto">
                    <div class="form-icon">
                        <input type="text" class="form-control form-control-icon" id="contractSearch" placeholder="Search contracts..." required>
                        <i class="ri-search-2-line text-muted"></i>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-light text-muted dropdown-toggle" type="button" id="contractSortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Sort By
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="contractSortDropdown">
                            <li><a class="dropdown-item" href="javascript:void(0)">Latest First</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)">Oldest First</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)">Contract Type</a></li>
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-outline-light text-muted dropdown-toggle" type="button" id="contractFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            Filter By
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="contractFilterDropdown">
                            <li><a class="dropdown-item" href="javascript:void(0)">All Contracts</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)">Active</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)">Expired</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)">Renewed</a></li>
                        </ul>
                    </div>
                    <a href="{% url 'employee:contract_create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg me-1"></i>New Contract
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-box table-responsive">
                    <table class="table table-hover text-nowrap">
                        <thead class="table-header">
                            <tr>
                                <th scope="col">Contract Number</th>
                                <th scope="col">Type</th>
                                <th scope="col">Duration</th>
                                <th scope="col">Salary</th>
                                <th scope="col">Status</th>
                                <th scope="col" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contract in contracts %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-md avatar-item bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                            <i class="ri-file-text-line"></i>
                                        </div>
                                        <div>
                                            <span class="fw-medium">{{ contract.contract_number }}</span>
                                            <br><small class="text-muted">{{ contract.created_at|date:"M d, Y" }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary rounded-pill">{{ contract.get_contract_type_display }}</span>
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ contract.start_date|date:"M d, Y" }}</strong> to 
                                        <strong>{{ contract.end_date|date:"M d, Y" }}</strong>
                                        <br><small class="text-muted">{{ contract.contract_duration_days }} days</small>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong>${{ contract.basic_salary|floatformat:2 }}</strong>
                                        {% if contract.allowances %}
                                            <br><small class="text-muted">+${{ contract.allowances|floatformat:2 }} allowances</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if contract.status == 'ACTIVE' %}
                                        <span class="badge bg-success rounded-pill">Active</span>
                                        {% if contract.days_remaining <= 30 %}
                                            <br><small class="text-warning">{{ contract.days_remaining }} days left</small>
                                        {% endif %}
                                    {% elif contract.status == 'EXPIRED' %}
                                        <span class="badge bg-danger rounded-pill">Expired</span>
                                    {% elif contract.status == 'RENEWED' %}
                                        <span class="badge bg-info rounded-pill">Renewed</span>
                                    {% else %}
                                        <span class="badge bg-secondary rounded-pill">{{ contract.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex justify-content-center action-buttons">
                                        <a href="{% url 'employee:contract_detail' contract.pk %}" class="btn icon-btn-sm btn-light-primary" title="View">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% if contract.status == 'ACTIVE' %}
                                        <a href="{% url 'employee:contract_renewal' contract.pk %}" class="btn icon-btn-sm btn-light-success" title="Renew">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </a>
                                        {% endif %}
                                        <a href="{% url 'employee:contract_update' contract.pk %}" class="btn icon-btn-sm btn-light-secondary" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="ri-file-text-line fs-48"></i>
                                        <p class="mt-2">No contracts found</p>
                                        <a href="{% url 'employee:contract_create' %}" class="btn btn-primary btn-sm">
                                            <i class="ri-add-line me-1"></i>Create First Contract
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h4>Compensation Details</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border">
                            <div class="card-body text-center">
                                <div class="fs-4 mb-3 bg-success-subtle text-success avatar-lg d-inline-flex align-items-center justify-content-center rounded-circle">
                                    <i class="ri-money-dollar-line"></i>
                                </div>
                                <h4>${{ employee.basic_salary|floatformat:2|default:"0.00" }}</h4>
                                <span class="text-muted">Basic Salary</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border">
                            <div class="card-body text-center">
                                <div class="fs-4 mb-3 bg-info-subtle text-info avatar-lg d-inline-flex align-items-center justify-content-center rounded-circle">
                                    <i class="ri-gift-line"></i>
                                </div>
                                <h4>${{ employee.allowances|floatformat:2|default:"0.00" }}</h4>
                                <span class="text-muted">Allowances</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border">
                            <div class="card-body text-center">
                                <div class="fs-4 mb-3 bg-warning-subtle text-warning avatar-lg d-inline-flex align-items-center justify-content-center rounded-circle">
                                    <i class="ri-heart-line"></i>
                                </div>
                                <h4>${{ employee.benefits|floatformat:2|default:"0.00" }}</h4>
                                <span class="text-muted">Benefits</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card bg-primary-subtle">
                            <div class="card-body text-center">
                                <h3 class="text-primary mb-1">
                                    ${{ employee.total_compensation|floatformat:2|default:"0.00" }}
                                </h3>
                                <p class="text-primary mb-0">Total Annual Compensation</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h4>Additional Information</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="table-responsive">
                            <table class="table table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td class="ps-0 fw-medium">National ID:</td>
                                        <td class="text-muted">{{ employee.national_id|default:"N/A" }}</td>
                                    </tr>
                                    <tr>
                                        <td class="ps-0 fw-medium">Bank Account:</td>
                                        <td class="text-muted">{{ employee.bank_account_number|default:"N/A" }}</td>
                                    </tr>
                                    <tr>
                                        <td class="ps-0 fw-medium">Date of Birth:</td>
                                        <td class="text-muted">{{ employee.date_of_birth|date:"M d, Y"|default:"N/A" }}</td>
                                    </tr>
                                    <tr>
                                        <td class="ps-0 fw-medium">Gender:</td>
                                        <td class="text-muted">{{ employee.get_gender_display|default:"N/A" }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="table-responsive">
                            <table class="table table-borderless mb-0">
                                <tbody>
                                    <tr>
                                        <td class="ps-0 fw-medium">Created By:</td>
                                        <td class="text-muted">{{ employee.created_by.get_full_name|default:"System" }}</td>
                                    </tr>
                                    <tr>
                                        <td class="ps-0 fw-medium">Created On:</td>
                                        <td class="text-muted">{{ employee.created_at|date:"M d, Y H:i" }}</td>
                                    </tr>
                                    <tr>
                                        <td class="ps-0 fw-medium">Last Updated:</td>
                                        <td class="text-muted">{{ employee.updated_at|date:"M d, Y H:i" }}</td>
                                    </tr>
                                    <tr>
                                        <td class="ps-0 fw-medium">Status:</td>
                                        <td class="text-muted">
                                            {% if employee.is_active %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-danger">Inactive</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                {% if employee.notes %}
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Notes:</h6>
                        <div class="bg-light p-3 rounded">
                            {{ employee.notes|linebreaks }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script src="/static/assets/libs/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const educationSearch = document.getElementById('educationSearch');
    const contractSearch = document.getElementById('contractSearch');
    
    if (educationSearch) {
        educationSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('.table-hover tbody tr');
            
            tableRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }
    
    if (contractSearch) {
        contractSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const contractRows = document.querySelectorAll('.table-hover tbody tr');
            
            contractRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    }
    
    const sortDropdowns = document.querySelectorAll('.dropdown-menu a');
    sortDropdowns.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const sortType = this.textContent.trim();
            console.log('Sorting by:', sortType);
        });
    });
});
</script>
{% endblock %}

