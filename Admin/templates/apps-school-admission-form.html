{% extends "partials/layouts/main.html" %}
{% load static %}

{% include "partials/main.html" %}
{% block meta %}
{% with title="Employee Form" %}
{% include "partials/title-meta.html" %}
{% endwith %}
{% endblock %}
{% block css %}
<link rel="stylesheet" href="/static/assets/libs/choices.js/public/assets/styles/choices.min.css">
<link rel="stylesheet" href="/static/assets/libs/dragula/dragula.min.css">
<link rel="stylesheet" href="/static/assets/libs/air-datepicker/air-datepicker.css">
{% endblock %}
{% block content %}
{% with title_sub="HR Management" title=page_title|default:"Employee Form"%}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <div class="fs-4 mb-3 bg-primary-subtle text-primary avatar-lg d-inline-flex align-items-center justify-content-center rounded-circle">
                    <i class="ri-user-line"></i>
                </div>
                <h4>{{ employee_stats.total_employees|default:0 }}</h4>
                <span>Total Employees</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="fs-4 mb-3 bg-warning-subtle text-warning avatar-lg d-inline-flex align-items-center justify-content-center rounded-circle">
                    <i class="ri-time-line"></i>
                </div>
                <h4>{{ employee_stats.probation_employees|default:0 }}</h4>
                <span>On Probation</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="fs-4 mb-3 bg-success-subtle text-success avatar-lg d-inline-flex align-items-center justify-content-center rounded-circle">
                    <i class="ri-checkbox-circle-line"></i>
                </div>
                <h4>{{ employee_stats.confirmed_employees|default:0 }}</h4>
                <span>Confirmed</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="fs-4 mb-3 bg-info-subtle text-info avatar-lg d-inline-flex align-items-center justify-content-center rounded-circle">
                    <i class="ri-building-line"></i>
                </div>
                <h4>{{ total_departments|default:0 }}</h4>
                <span>Departments</span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4>{{ form_title|default:"Employee Information" }}</h4>
                <div class="d-flex gap-2">
                    <a href="{% url 'employee:employee_list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="ri-arrow-left-line me-1"></i>Back to List
                    </a>
                    {% if is_update %}
                    <a href="{% url 'employee:employee_detail' object.pk %}" class="btn btn-outline-primary btn-sm">
                        <i class="ri-eye-line me-1"></i>View Details
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="employeeForm">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}
                    
                    <div class="row g-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="ri-user-line me-2"></i>Personal Information
                            </h6>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="employee_code" class="form-label">
                                Employee Code <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" name="employee_code" id="employee_code" 
                                   placeholder="Enter employee code" value="{{ object.user.employee_code|default:'' }}" required>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="first_name" class="form-label">
                                First Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" name="first_name" id="first_name" 
                                   placeholder="Enter first name" value="{{ object.user.first_name|default:'' }}" required>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="last_name" class="form-label">
                                Last Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" name="last_name" id="last_name" 
                                   placeholder="Enter last name" value="{{ object.user.last_name|default:'' }}" required>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="middle_name" class="form-label">Middle Name</label>
                            <input type="text" class="form-control" name="middle_name" id="middle_name" 
                                   placeholder="Enter middle name" value="{{ object.user.middle_name|default:'' }}">
                        </div>
                        
                        <div class="col-md-4">
                            <label for="date_of_birth" class="form-label">
                                Date of Birth <span class="text-danger">*</span>
                            </label>
                            <input type="date" class="form-control" name="date_of_birth" id="date_of_birth" 
                                   value="{{ object.date_of_birth|date:'Y-m-d'|default:'' }}" required>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="gender" class="form-label">
                                Gender <span class="text-danger">*</span>
                            </label>
                            <select class="form-control" name="gender" id="gender" required>
                                <option value="">Select Gender</option>
                                <option value="M" {% if object.gender == 'M' %}selected{% endif %}>Male</option>
                                <option value="F" {% if object.gender == 'F' %}selected{% endif %}>Female</option>
                                <option value="O" {% if object.gender == 'O' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="email" class="form-label">
                                Email Address <span class="text-danger">*</span>
                            </label>
                            <input type="email" class="form-control" name="email" id="email" 
                                   placeholder="Enter email address" value="{{ object.user.email|default:'' }}" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="phone_number" class="form-label">
                                Phone Number <span class="text-danger">*</span>
                            </label>
                            <input type="tel" class="form-control" name="phone_number" id="phone_number" 
                                   placeholder="Enter phone number" value="{{ object.phone_number|default:'' }}" required>
                        </div>
                        
                        <div class="col-12">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" name="address" id="address" rows="3" 
                                      placeholder="Enter full address">{{ object.address|default:'' }}</textarea>
                        </div>
                        
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                                <i class="ri-briefcase-line me-2"></i>Employment Information
                            </h6>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="department" class="form-label">
                                Department <span class="text-danger">*</span>
                            </label>
                            <select class="form-control" name="department" id="department" required>
                                <option value="">Select Department</option>
                                {% for dept in departments %}
                                <option value="{{ dept.id }}" {% if object.user.department.id == dept.id %}selected{% endif %}>
                                    {{ dept.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="role" class="form-label">
                                Role <span class="text-danger">*</span>
                            </label>
                            <select class="form-control" name="role" id="role" required>
                                <option value="">Select Role</option>
                                {% for role in roles %}
                                <option value="{{ role.id }}" {% if object.user.role.id == role.id %}selected{% endif %}>
                                    {{ role.display_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="job_title" class="form-label">
                                Job Title <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" name="job_title" id="job_title" 
                                   placeholder="Enter job title" value="{{ object.user.job_title|default:'' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="hire_date" class="form-label">
                                Hire Date <span class="text-danger">*</span>
                            </label>
                            <input type="date" class="form-control" name="hire_date" id="hire_date" 
                                   value="{{ object.user.hire_date|date:'Y-m-d'|default:'' }}" required>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="employment_status" class="form-label">
                                Employment Status <span class="text-danger">*</span>
                            </label>
                            <select class="form-control" name="employment_status" id="employment_status" required>
                                <option value="">Select Status</option>
                                <option value="PROBATION" {% if object.employment_status == 'PROBATION' %}selected{% endif %}>Probation</option>
                                <option value="CONFIRMED" {% if object.employment_status == 'CONFIRMED' %}selected{% endif %}>Confirmed</option>
                                <option value="ACTIVE" {% if object.employment_status == 'ACTIVE' %}selected{% endif %}>Active</option>
                                <option value="TERMINATED" {% if object.employment_status == 'TERMINATED' %}selected{% endif %}>Terminated</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="grade_level" class="form-label">Grade Level</label>
                            <select class="form-control" name="grade_level" id="grade_level">
                                <option value="">Select Grade Level</option>
                                <option value="ENTRY" {% if object.grade_level == 'ENTRY' %}selected{% endif %}>Entry Level</option>
                                <option value="JUNIOR" {% if object.grade_level == 'JUNIOR' %}selected{% endif %}>Junior</option>
                                <option value="SENIOR" {% if object.grade_level == 'SENIOR' %}selected{% endif %}>Senior</option>
                                <option value="LEAD" {% if object.grade_level == 'LEAD' %}selected{% endif %}>Lead</option>
                                <option value="MANAGER" {% if object.grade_level == 'MANAGER' %}selected{% endif %}>Manager</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="manager" class="form-label">Reporting Manager</label>
                            <select class="form-control" name="manager" id="manager">
                                <option value="">Select Manager</option>
                                {% for manager in managers %}
                                <option value="{{ manager.id }}" {% if object.user.manager.id == manager.id %}selected{% endif %}>
                                    {{ manager.get_full_name }} ({{ manager.employee_code }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="probation_end_date" class="form-label">Probation End Date</label>
                            <input type="date" class="form-control" name="probation_end_date" id="probation_end_date" 
                                   value="{{ object.probation_end_date|date:'Y-m-d'|default:'' }}">
                            <div class="form-text">Leave blank if not applicable</div>
                        </div>
                        
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                                <i class="ri-money-dollar-line me-2"></i>Compensation Information
                            </h6>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="basic_salary" class="form-label">
                                Basic Salary <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="basic_salary" id="basic_salary" 
                                       placeholder="0.00" step="0.01" min="0" value="{{ object.basic_salary|default:'' }}" required>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="allowances" class="form-label">Allowances</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="allowances" id="allowances" 
                                       placeholder="0.00" step="0.01" min="0" value="{{ object.allowances|default:'' }}">
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="benefits" class="form-label">Benefits</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" name="benefits" id="benefits" 
                                       placeholder="0.00" step="0.01" min="0" value="{{ object.benefits|default:'' }}">
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3 mt-4">
                                <i class="ri-file-text-line me-2"></i>Additional Information
                            </h6>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="emergency_contact_name" class="form-label">
                                Emergency Contact Name
                            </label>
                            <input type="text" class="form-control" name="emergency_contact_name" id="emergency_contact_name" 
                                   placeholder="Enter emergency contact name" value="{{ object.emergency_contact_name|default:'' }}">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="emergency_contact_phone" class="form-label">
                                Emergency Contact Phone
                            </label>
                            <input type="tel" class="form-control" name="emergency_contact_phone" id="emergency_contact_phone" 
                                   placeholder="Enter emergency contact phone" value="{{ object.emergency_contact_phone|default:'' }}">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="national_id" class="form-label">National ID</label>
                            <input type="text" class="form-control" name="national_id" id="national_id" 
                                   placeholder="Enter national ID" value="{{ object.national_id|default:'' }}">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="bank_account_number" class="form-label">Bank Account Number</label>
                            <input type="text" class="form-control" name="bank_account_number" id="bank_account_number" 
                                   placeholder="Enter bank account number" value="{{ object.bank_account_number|default:'' }}">
                        </div>
                        
                        <div class="col-12">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" name="notes" id="notes" rows="4" 
                                      placeholder="Enter any additional notes">{{ object.notes|default:'' }}</textarea>
                        </div>
                        
                        <div class="col-12">
                            <div class="d-flex gap-3 justify-content-end mt-4">
                                <a href="{% url 'employee:employee_list' %}" class="btn btn-outline-secondary">
                                    <i class="ri-close-line me-1"></i>Cancel
                                </a>
                                <button type="button" class="btn btn-outline-primary" onclick="validateForm()">
                                    <i class="ri-check-line me-1"></i>Validate
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="ri-save-line me-1"></i>
                                    {% if is_update %}Update Employee{% else %}Create Employee{% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="validationModalLabel">Form Validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="validationResults"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script src="/static/assets/libs/choices.js/public/assets/scripts/choices.min.js"></script>
<script src="/static/assets/libs/air-datepicker/air-datepicker.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('employeeForm');
    const employeeCodeField = document.getElementById('employee_code');
    const emailField = document.getElementById('email');
    const departmentField = document.getElementById('department');
    const roleField = document.getElementById('role');
    const managerField = document.getElementById('manager');
    
    if (employeeCodeField) {
        employeeCodeField.addEventListener('blur', function() {
            validateEmployeeCode(this.value);
        });
    }
    
    if (emailField) {
        emailField.addEventListener('blur', function() {
            validateEmail(this.value);
        });
    }
    
    const dateFields = document.querySelectorAll('input[type="date"]');
    dateFields.forEach(field => {
        if (field.classList.contains('air-datepicker')) return;
        
        new AirDatepicker(field, {
            locale: {
                days: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
                daysShort: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                daysMin: ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'],
                months: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
                monthsShort: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
            },
            dateFormat: 'yyyy-MM-dd',
            autoClose: true
        });
    });
    
    if (departmentField && roleField && managerField) {
        new Choices(departmentField, {
            searchEnabled: true,
            placeholder: true,
            placeholderValue: 'Select Department'
        });
        
        new Choices(roleField, {
            searchEnabled: true,
            placeholder: true,
            placeholderValue: 'Select Role'
        });
        
        new Choices(managerField, {
            searchEnabled: true,
            placeholder: true,
            placeholderValue: 'Select Manager'
        });
    }
    
    function validateEmployeeCode(code) {
        if (!code) return;
        
        const employeeId = '{{ object.pk|default:"" }}';
        fetch(`{% url 'employee:validate_employee_code_ajax' %}?employee_code=${code}&employee_id=${employeeId}`)
            .then(response => response.json())
            .then(data => {
                const field = employeeCodeField.parentElement;
                const existingFeedback = field.querySelector('.validation-feedback');
                if (existingFeedback) existingFeedback.remove();
                
                const feedback = document.createElement('div');
                feedback.className = `validation-feedback small ${data.valid ? 'text-success' : 'text-danger'}`;
                feedback.textContent = data.message;
                field.appendChild(feedback);
                
                employeeCodeField.classList.toggle('is-valid', data.valid);
                employeeCodeField.classList.toggle('is-invalid', !data.valid);
            });
    }
    
    function validateEmail(email) {
        if (!email) return;
        
        const employeeId = '{{ object.pk|default:"" }}';
        fetch(`{% url 'employee:validate_email_ajax' %}?email=${email}&employee_id=${employeeId}`)
            .then(response => response.json())
            .then(data => {
                const field = emailField.parentElement;
                const existingFeedback = field.querySelector('.validation-feedback');
                if (existingFeedback) existingFeedback.remove();
                
                const feedback = document.createElement('div');
                feedback.className = `validation-feedback small ${data.valid ? 'text-success' : 'text-danger'}`;
                feedback.textContent = data.message;
                field.appendChild(feedback);
                
                emailField.classList.toggle('is-valid', data.valid);
                emailField.classList.toggle('is-invalid', !data.valid);
            });
    }
    
    window.validateForm = function() {
        const formData = new FormData(form);
        const results = [];
        
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                const label = field.previousElementSibling;
                const fieldName = label ? label.textContent.replace('*', '').trim() : field.name;
                results.push(`${fieldName} is required`);
            }
        });
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailField && emailField.value && !emailRegex.test(emailField.value)) {
            results.push('Please enter a valid email address');
        }
        
        const phoneField = document.getElementById('phone_number');
        if (phoneField && phoneField.value) {
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            if (!phoneRegex.test(phoneField.value.replace(/\s/g, ''))) {
                results.push('Please enter a valid phone number');
            }
        }
        
        const salaryField = document.getElementById('basic_salary');
        if (salaryField && salaryField.value && parseFloat(salaryField.value) <= 0) {
            results.push('Basic salary must be greater than 0');
        }
        
        const resultsDiv = document.getElementById('validationResults');
        if (results.length === 0) {
            resultsDiv.innerHTML = '<div class="alert alert-success"><i class="ri-check-line me-2"></i>All validations passed! Form is ready to submit.</div>';
        } else {
            resultsDiv.innerHTML = '<div class="alert alert-danger"><h6>Please fix the following issues:</h6><ul class="mb-0">' + 
                results.map(result => `<li>${result}</li>`).join('') + '</ul></div>';
        }
        
        new bootstrap.Modal(document.getElementById('validationModal')).show();
    };
    
    form.addEventListener('submit', function(e) {
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="ri-loader-4-line me-1 spinner-border spinner-border-sm"></i>Processing...';
    });
});
</script>
{% endblock %}

