{% extends "partials/layouts/main.html" %}
{% load static %}

{% include "partials/main.html" %}
{% block meta %}
{% with title="Analytics" %}
{% include "partials/title-meta.html" %}
{% endwith %}
{% endblock %}
{% block css %}
<link rel="stylesheet" type="text/css" href="/static/assets/libs/jsvectormap/jsvectormap.min.css">
{% endblock %}
{% block content %}
{% with title_sub="Dashboard" title="Analytics"%}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-xl-9">
        <div class="card">
            <div class="card-header pb-0">
                <h4>System Overview</h4>
                <a href="{% url 'accounts:employee_list' %}" class="link">View All</a>
            </div>
            <div class="card-body">
                <div class="row gy-6">
                    <div class="col-md-6 col-xl-3">
                        <div class="card border shadow-none mb-0">
                            <div class="card-body">
                                <div class="h-50px w-50px position-relative d-flex justify-content-center align-items-center text-primary bg-light-subtle rounded-2 fs-4">
                                    <i class="ri-user-line"></i>
                                </div>
                                <h2 class="mt-8 mb-2 fs-24 fw-semibold">
                                    <span class="counter-value" data-target="{{ employee_stats.total_employees|default:0 }}">{{ employee_stats.total_employees|default:0 }}</span>
                                </h2>
                                <p class="mb-0 text-truncate fs-16 mb-1">Total Employees</p>
                                <span class="text-primary">{{ employee_stats.active_employees|default:0 }} Active</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border shadow-none mb-0">
                            <div class="card-body">
                                <div class="h-50px w-50px position-relative d-flex justify-content-center align-items-center text-success bg-success-subtle rounded-2 fs-4">
                                    <i class="ri-building-line"></i>
                                </div>
                                <h2 class="mt-8 mb-2 fs-24 fw-semibold">
                                    <span class="counter-value" data-target="{{ total_departments|default:0 }}">{{ total_departments|default:0 }}</span>
                                </h2>
                                <p class="mb-0 text-truncate fs-16 mb-1">Departments</p>
                                <span class="text-success">{{ total_roles|default:0 }} Roles</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border shadow-none mb-0">
                            <div class="card-body">
                                <div class="h-50px w-50px position-relative d-flex justify-content-center align-items-center text-warning bg-warning-subtle rounded-2 fs-4">
                                    <i class="ri-file-text-line"></i>
                                </div>
                                <h2 class="mt-8 mb-2 fs-24 fw-semibold">
                                    <span class="counter-value" data-target="{{ contract_stats.active_contracts|default:0 }}">{{ contract_stats.active_contracts|default:0 }}</span>
                                </h2>
                                <p class="mb-0 text-truncate fs-16 mb-1">Active Contracts</p>
                                <span class="text-warning">{{ contracts_expiring|default:0 }} Expiring Soon</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-xl-3">
                        <div class="card border shadow-none mb-0">
                            <div class="card-body">
                                <div class="h-50px w-50px position-relative d-flex justify-content-center align-items-center text-info bg-info-subtle rounded-2 fs-4">
                                    <i class="ri-shield-check-line"></i>
                                </div>
                                <h2 class="mt-8 mb-2 fs-24 fw-semibold">
                                    <span class="counter-value" data-target="{{ session_analytics.active_sessions|default:0 }}">{{ session_analytics.active_sessions|default:0 }}</span>
                                </h2>
                                <p class="mb-0 text-truncate fs-16 mb-1">Active Sessions</p>
                                <span class="text-info">Current Users</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3">
        <div class="card card-h-100">
            <div class="card-header">
                <h4>User Status Distribution</h4>
            </div>
            <div class="card-body">
                <div id="user-status-chart"></div>
                <div class="row mt-3">
                    {% for status in user_analytics.status_distribution %}
                    <div class="col-6 py-1">
                        <ul class="list-unstyled mb-0">
                            <li class="d-flex align-items-center">
                                <i class="bi bi-circle-fill me-2 {% if status.status == 'ACTIVE' %}text-success{% elif status.status == 'INACTIVE' %}text-danger{% elif status.status == 'SUSPENDED' %}text-warning{% else %}text-secondary{% endif %}"></i>
                                <span class="small">{{ status.status|title }} ({{ status.count }})</span>
                            </li>
                        </ul>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header">
                <h4>Department Analytics</h4>
                <a href="{% url 'employee:department_list' %}" class="link">View All</a>
            </div>
            <div class="card-body">
                <div id="department-chart"></div>
                <div class="row mt-4">
                    {% for dept in department_analytics.employee_distribution|slice:":6" %}
                    <div class="col-md-4 col-sm-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="avatar avatar-sm me-3">
                                <span class="avatar-title bg-primary-subtle text-primary rounded-circle">
                                    {{ dept.name|first }}
                                </span>
                            </div>
                            <div>
                                <h6 class="mb-0">{{ dept.name }}</h6>
                                <small class="text-muted">{{ dept.employee_count }} employees</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-4">
        <div class="card">
            <div class="card-header">
                <h4>Role Distribution</h4>
                <a href="{% url 'accounts:role_list' %}" class="link">View All</a>
            </div>
            <div class="card-body">
                <div id="role-chart"></div>
                <div class="mt-3">
                    {% for role in role_analytics.role_distribution|slice:":5" %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="small">{{ role.display_name|default:"Unknown" }}</span>
                        <span class="badge bg-primary-subtle text-primary">{{ role.user_count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-6">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header flex-wrap gap-4">
                        <h4 class="flex-grow-1 mb-0">Recent Employees</h4>
                        <div class="d-flex gap-3 align-items-center">
                            <div class="form-icon">
                                <input type="text" class="form-control form-control-icon rounded-2" id="employeeSearch" placeholder="Search Employees..." required>
                                <i class="ri-search-2-line text-muted"></i>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Filters
                                </button>
                                <div class="dropdown-menu dropdown-menu-end">
                                    <a class="dropdown-item" href="javascript:void(0)">All Status</a>
                                    <a class="dropdown-item" href="javascript:void(0)">Active</a>
                                    <a class="dropdown-item" href="javascript:void(0)">Probation</a>
                                    <a class="dropdown-item" href="javascript:void(0)">Confirmed</a>
                                    <a class="dropdown-item" href="javascript:void(0)">Inactive</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-box table-responsive">
                            <table class="table table-hover text-nowrap align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Employee</th>
                                        <th>Department</th>
                                        <th>Status</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for employee in recent_employees %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar avatar-sm me-2">
                                                    <span class="avatar-title bg-primary-subtle text-primary rounded-circle">
                                                        {{ employee.user.first_name|first }}{{ employee.user.last_name|first }}
                                                    </span>
                                                </div>
                                                <div>
                                                    <strong>{{ employee.user.get_full_name }}</strong>
                                                    <br><small class="text-muted">{{ employee.user.employee_code }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ employee.user.department.name|default:"N/A" }}</td>
                                        <td>
                                            {% if employee.employment_status == 'ACTIVE' %}
                                                <span class="badge bg-success-subtle text-success">Active</span>
                                            {% elif employee.employment_status == 'PROBATION' %}
                                                <span class="badge bg-warning-subtle text-warning">Probation</span>
                                            {% elif employee.employment_status == 'CONFIRMED' %}
                                                <span class="badge bg-primary-subtle text-primary">Confirmed</span>
                                            {% else %}
                                                <span class="badge bg-secondary-subtle text-secondary">{{ employee.employment_status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="action-buttons">
                                                <a href="{% url 'accounts:employee_detail' employee.user.pk %}" class="btn btn-sm btn-outline-primary" title="View Details">
                                                    <i class="ri-eye-line"></i>
                                                </a>
                                                <a href="{% url 'accounts:employee_update' employee.user.pk %}" class="btn btn-sm btn-outline-info" title="Edit Employee">
                                                    <i class="ri-edit-line"></i>
                                                </a>
                                            </div>
                                        </td>                                        
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center">No recent employees found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4>Notifications & Alerts</h4>
                        <a href="{% url 'accounts:audit_logs' %}" class="link">View All</a>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% if probation_notifications %}
                                {% for notification in probation_notifications|slice:":5" %}
                                <div class="list-group-item border-0 px-0">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar avatar-sm me-3">
                                            <span class="avatar-title bg-warning-subtle text-warning rounded-circle">
                                                <i class="ri-time-line"></i>
                                            </span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ notification.user.get_full_name }}</h6>
                                            <p class="mb-0 text-muted small">Probation ends on {{ notification.probation_end_date|date:"M d, Y" }}</p>
                                        </div>
                                        <small class="text-muted">{{ notification.probation_end_date|timeuntil }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                            
                            {% if contract_notifications %}
                                {% for notification in contract_notifications|slice:":3" %}
                                <div class="list-group-item border-0 px-0">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar avatar-sm me-3">
                                            <span class="avatar-title bg-danger-subtle text-danger rounded-circle">
                                                <i class="ri-file-text-line"></i>
                                            </span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ notification.employee.get_full_name }}</h6>
                                            <p class="mb-0 text-muted small">Contract expires on {{ notification.end_date|date:"M d, Y" }}</p>
                                        </div>
                                        <small class="text-muted">{{ notification.end_date|timeuntil }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                            
                            {% if birthday_notifications %}
                                {% for notification in birthday_notifications|slice:":2" %}
                                <div class="list-group-item border-0 px-0">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar avatar-sm me-3">
                                            <span class="avatar-title bg-success-subtle text-success rounded-circle">
                                                <i class="ri-cake-line"></i>
                                            </span>
                                        </div>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">{{ notification.user.get_full_name }}</h6>
                                            <p class="mb-0 text-muted small">Birthday on {{ notification.date_of_birth|date:"M d" }}</p>
                                        </div>
                                        <small class="text-muted">Today</small>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                            
                            {% if not probation_notifications and not contract_notifications and not birthday_notifications %}
                            <div class="text-center py-4">
                                <i class="ri-notification-line fs-48 text-muted"></i>
                                <p class="text-muted mt-2">No notifications at this time</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h4>Quick Actions</h4>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-6">
                                <a href="{% url 'accounts:employee_create' %}" class="btn btn-primary w-100">
                                    <i class="ri-user-add-line me-2"></i>Add Employee
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="{% url 'employee:department_create' %}" class="btn btn-outline-primary w-100">
                                    <i class="ri-building-add-line me-2"></i>New Department
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="{% url 'accounts:bulk_employee_upload' %}" class="btn btn-outline-secondary w-100">
                                    <i class="ri-upload-line me-2"></i>Bulk Import
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="{% url 'accounts:employee_export' %}" class="btn btn-outline-success w-100">
                                    <i class="ri-download-line me-2"></i>Export Data
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xl-12">
        <div class="card">
            <div class="card-header">
                <h4>System Statistics</h4>
                <div class="d-flex gap-2">
                    <a href="{% url 'accounts:user_sessions' %}" class="btn btn-sm btn-outline-primary">
                        <i class="ri-shield-check-line me-1"></i>Sessions
                    </a>
                    <a href="{% url 'accounts:audit_logs' %}" class="btn btn-sm btn-outline-secondary">
                        <i class="ri-file-list-line me-1"></i>Audit Logs
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h-60px w-60px mx-auto d-flex justify-content-center align-items-center text-success bg-success-subtle rounded-circle fs-3 mb-3">
                                <i class="ri-user-check-line"></i>
                            </div>
                            <h4 class="mb-1">{{ employee_stats.confirmed_employees|default:0 }}</h4>
                            <p class="text-muted mb-0">Confirmed Employees</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h-60px w-60px mx-auto d-flex justify-content-center align-items-center text-warning bg-warning-subtle rounded-circle fs-3 mb-3">
                                <i class="ri-user-settings-line"></i>
                            </div>
                            <h4 class="mb-1">{{ employee_stats.probation_employees|default:0 }}</h4>
                            <p class="text-muted mb-0">On Probation</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h-60px w-60px mx-auto d-flex justify-content-center align-items-center text-info bg-info-subtle rounded-circle fs-3 mb-3">
                                <i class="ri-shield-check-line"></i>
                            </div>
                            <h4 class="mb-1">{{ session_analytics.active_sessions|default:0 }}</h4>
                            <p class="text-muted mb-0">Active Sessions</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <div class="h-60px w-60px mx-auto d-flex justify-content-center align-items-center text-primary bg-primary-subtle rounded-circle fs-3 mb-3">
                                <i class="ri-building-2-line"></i>
                            </div>
                            <h4 class="mb-1">{{ total_departments|default:0 }}</h4>
                            <p class="text-muted mb-0">Active Departments</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<script src="/static/assets/libs/apexcharts/apexcharts.min.js"></script>
<script src="/static/assets/libs/jsvectormap/jsvectormap.min.js"></script>
<script src="/static/assets/libs/jsvectormap/maps/world-merc.js"></script>
<script src="/static/assets/js/pages/dashboard-analytics.init.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const employeeSearch = document.getElementById('employeeSearch');
    if (employeeSearch) {
        employeeSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const tableRows = document.querySelectorAll('tbody tr');
            
            tableRows.forEach(row => {
                const employeeName = row.querySelector('td:nth-child(2)');
                if (employeeName) {
                    const text = employeeName.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                }
            });
        });
    }
    
    {% if user_analytics.status_distribution %}
    const userStatusData = [
        {% for status in user_analytics.status_distribution %}
        {{ status.count }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const userStatusLabels = [
        {% for status in user_analytics.status_distribution %}
        '{{ status.status|title }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const userStatusOptions = {
        series: userStatusData,
        chart: {
            type: 'donut',
            height: 200
        },
        labels: userStatusLabels,
        colors: ['#10b981', '#ef4444', '#f59e0b', '#6b7280'],
        legend: {
            show: false
        }
    };
    
    const userStatusChart = new ApexCharts(document.querySelector("#user-status-chart"), userStatusOptions);
    userStatusChart.render();
    {% endif %}
    
    {% if department_analytics.employee_distribution %}
    const departmentData = [
        {% for dept in department_analytics.employee_distribution|slice:":8" %}
        {{ dept.employee_count }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const departmentLabels = [
        {% for dept in department_analytics.employee_distribution|slice:":8" %}
        '{{ dept.name }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const departmentOptions = {
        series: [{
            name: 'Employees',
            data: departmentData
        }],
        chart: {
            type: 'bar',
            height: 300
        },
        xaxis: {
            categories: departmentLabels
        },
        colors: ['#3b82f6']
    };
    
    const departmentChart = new ApexCharts(document.querySelector("#department-chart"), departmentOptions);
    departmentChart.render();
    {% endif %}
    
    {% if role_analytics.role_distribution %}
    const roleData = [
        {% for role in role_analytics.role_distribution|slice:":6" %}
        {{ role.user_count }}{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    const roleLabels = [
        {% for role in role_analytics.role_distribution|slice:":6" %}
        '{{ role.display_name|default:"Unknown" }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const roleOptions = {
        series: roleData,
        chart: {
            type: 'pie',
            height: 250
        },
        labels: roleLabels,
        colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'],
        legend: {
            show: false
        }
    };
    
    const roleChart = new ApexCharts(document.querySelector("#role-chart"), roleOptions);
    roleChart.render();
    {% endif %}
});
</script>
{% endblock %}

