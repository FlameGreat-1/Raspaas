{% extends "partials/layouts/main.html" %}
{% load static %}
{% load import_filters %}

{% include "partials/main.html" %}
{% block meta %}
{% with title="Import Results" %}
{% include "partials/title-meta.html" %}
{% endwith %}
{% endblock %}

{% block css %}
<link rel="stylesheet" href="/static/assets/libs/datatables.net-bs5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="/static/assets/libs/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css">
<style>
    .scrollable-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #f0f0f0;
        border-radius: 0.25rem;
    }
    .scrollable-container .table {
        margin-bottom: 0;
    }
    .scrollable-container thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 1;
    }
</style>
{% endblock %}

{% block content %}
{% with title_sub="Employee Management" title="Import Results" %}
{% include "partials/pagetitle.html" %}
{% endwith %}

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header border-bottom">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h4 class="card-title mb-0">Employee Import Results</h4>
                        <p class="text-muted mb-0">Summary of the employee import operation</p>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="d-flex justify-content-end">
                            <a href="{% url 'accounts:employee_list' %}" class="btn btn-primary me-2">
                                <i class="ri-user-line me-1"></i>View Employees
                            </a>
                            <a href="{% url 'accounts:bulk_employee_upload' %}" class="btn btn-outline-primary">
                                <i class="ri-upload-cloud-line me-1"></i>New Import
                            </a>
                        </div>
                    </div>                    
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="alert alert-{% if results.success_count > 0 %}success{% else %}warning{% endif %}" role="alert">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="ri-{% if results.success_count > 0 %}check-double-line{% else %}error-warning-line{% endif %} fs-18 align-middle me-2"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h5 class="alert-heading">Import Completed</h5>
                                    <p class="mb-0">
                                        Processed {{ results.total_rows }} rows with {{ results.success_count }} successful operations 
                                        ({{ results.created_count }} created, {{ results.updated_count }} updated) 
                                        and {{ results.error_count }} errors.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary-subtle border-0">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-sm">
                                            <div class="avatar-title bg-primary rounded-circle">
                                                <i class="ri-file-excel-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="mb-1">{{ results.total_rows }}</h5>
                                        <p class="text-muted mb-0 fs-13">Total Rows</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success-subtle border-0">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-sm">
                                            <div class="avatar-title bg-success rounded-circle">
                                                <i class="ri-user-add-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="mb-1">{{ results.created_count }}</h5>
                                        <p class="text-muted mb-0 fs-13">Created</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info-subtle border-0">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-sm">
                                            <div class="avatar-title bg-info rounded-circle">
                                                <i class="ri-refresh-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="mb-1">{{ results.updated_count }}</h5>
                                        <p class="text-muted mb-0 fs-13">Updated</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger-subtle border-0">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <div class="avatar-sm">
                                            <div class="avatar-title bg-danger rounded-circle">
                                                <i class="ri-error-warning-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h5 class="mb-1">{{ results.error_count }}</h5>
                                        <p class="text-muted mb-0 fs-13">Errors</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if results.new_users %}
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card border">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">New Users Created ({{ results.new_users|length }})</h5>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-container">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle" id="newUsersTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Employee</th>
                                                    <th>Email</th>
                                                    <th>Employee Code</th>
                                                    <th>Temporary Password</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for user in results.new_users %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="flex-shrink-0 me-2">
                                                                <div class="avatar-xs">
                                                                    <div class="avatar-title bg-primary-subtle text-primary rounded-circle">
                                                                        {{ user.name|slice:":2" }}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="flex-grow-1">
                                                                <h6 class="mb-0">{{ user.name }}</h6>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ user.email }}</td>
                                                    <td><span class="badge bg-primary-subtle text-primary">{{ user.employee_code }}</span></td>
                                                    <td>
                                                        <div class="input-group">
                                                            <input type="password" class="form-control form-control-sm password-input" value="{{ user.temp_password }}" readonly>
                                                            <button class="btn btn-sm btn-outline-secondary toggle-password" type="button">
                                                                <i class="ri-eye-line"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-primary copy-password" type="button" data-password="{{ user.temp_password }}">
                                                                <i class="ri-clipboard-line"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-primary" id="copyAllPasswords">
                                        <i class="ri-clipboard-line me-1"></i>Copy All Credentials
                                    </button>
                                    <button class="btn btn-outline-primary ms-2" id="downloadCredentials">
                                        <i class="ri-download-line me-1"></i>Download as CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% if results.errors %}
                <div class="row">
                    <div class="col-md-12">
                        <div class="card border">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Errors ({{ results.errors|length }})</h5>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-container">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="errorsTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th width="15%">Row</th>
                                                    <th>Error Message</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for error in results.errors %}
                                                <tr>
                                                    <td>
                                                        {% if "Row " in error %}
                                                        <span class="badge bg-danger">{{ error|slice:"4:"|cut:" "|split_row_number }}</span>
                                                        {% else %}
                                                        <span class="badge bg-danger">General</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="text-danger">
                                                        {% if "Row " in error %}
                                                        {{ error|get_error_message }}
                                                        {% else %}
                                                        {{ error }}
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if results.warnings %}
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card border">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Warnings ({{ results.warnings|length }})</h5>
                            </div>
                            <div class="card-body">
                                <div class="scrollable-container">
                                    <ul class="list-group">
                                        {% for warning in results.warnings %}
                                        <li class="list-group-item list-group-item-warning">
                                            <i class="ri-error-warning-line me-2"></i>{{ warning }}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="/static/assets/libs/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="/static/assets/libs/datatables.net-bs5/js/dataTables.bootstrap5.min.js"></script>
<script src="/static/assets/libs/datatables.net-responsive/js/dataTables.responsive.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize DataTables
        if (document.getElementById('newUsersTable')) {
            $('#newUsersTable').DataTable({
                responsive: true,
                lengthMenu: [5, 10, 25, 50],
                pageLength: 10,
                scrollY: '350px',
                scrollCollapse: true,
                language: {
                    search: "<i class='ri-search-line'></i>",
                    searchPlaceholder: "Search users...",
                    paginate: {
                        previous: "<i class='ri-arrow-left-s-line'></i>",
                        next: "<i class='ri-arrow-right-s-line'></i>"
                    }
                }
            });
        }
        
        if (document.getElementById('errorsTable')) {
            $('#errorsTable').DataTable({
                responsive: true,
                lengthMenu: [5, 10, 25, 50],
                pageLength: 10,
                scrollY: '350px',
                scrollCollapse: true,
                language: {
                    search: "<i class='ri-search-line'></i>",
                    searchPlaceholder: "Search errors...",
                    paginate: {
                        previous: "<i class='ri-arrow-left-s-line'></i>",
                        next: "<i class='ri-arrow-right-s-line'></i>"
                    }
                }
            });
        }
        
        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.closest('.input-group').querySelector('.password-input');
                const icon = this.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('ri-eye-line');
                    icon.classList.add('ri-eye-off-line');
                } else {
                    input.type = 'password';
                    icon.classList.remove('ri-eye-off-line');
                    icon.classList.add('ri-eye-line');
                }
            });
        });
        
        // Copy individual password
        document.querySelectorAll('.copy-password').forEach(button => {
            button.addEventListener('click', function() {
                const password = this.getAttribute('data-password');
                navigator.clipboard.writeText(password).then(() => {
                    // Show tooltip or notification
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<i class="ri-check-line"></i>';
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                    }, 1500);
                });
            });
        });
        
        // Copy all credentials
        document.getElementById('copyAllPasswords')?.addEventListener('click', function() {
            const users = [];
            {% for user in results.new_users %}
            users.push({
                name: "{{ user.name }}",
                email: "{{ user.email }}",
                employee_code: "{{ user.employee_code }}",
                password: "{{ user.temp_password }}"
            });
            {% endfor %}
            
            let text = "Employee Credentials:\n\n";
            users.forEach(user => {
                text += `Name: ${user.name}\n`;
                text += `Email: ${user.email}\n`;
                text += `Employee Code: ${user.employee_code}\n`;
                text += `Temporary Password: ${user.password}\n\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => {
                // Show notification
                const originalHTML = this.innerHTML;
                this.innerHTML = '<i class="ri-check-line me-1"></i>Copied!';
                setTimeout(() => {
                    this.innerHTML = originalHTML;
                }, 1500);
            });
        });
        
        // Download credentials as CSV
        document.getElementById('downloadCredentials')?.addEventListener('click', function() {
            const users = [];
            {% for user in results.new_users %}
            users.push({
                name: "{{ user.name }}",
                email: "{{ user.email }}",
                employee_code: "{{ user.employee_code }}",
                password: "{{ user.temp_password }}"
            });
            {% endfor %}
            
            let csv = "Name,Email,Employee Code,Temporary Password\n";
            users.forEach(user => {
                csv += `"${user.name}","${user.email}","${user.employee_code}","${user.password}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'employee_credentials.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    });
</script>
{% endblock %}

